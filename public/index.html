<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AssistBerry AI</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    


    <style>
        /* =========================================
           1. Design Tokens (Luxury Dark Theme)
           ========================================= */
        :root {
            /* Backgrounds */
            --bg-gradient: linear-gradient(135deg, #0f1014 0%, #181920 100%);
            --sidebar-glass: rgba(22, 23, 28, 0.75);
            --header-glass: rgba(22, 23, 28, 0.6);
            --input-glass: rgba(30, 32, 38, 0.85);
            
            /* Text Colors */
            --text-primary: #f8f9fa;
            --text-secondary: #aeb5bc;
            --text-dim: #6c757d;

            /* Accents */
            --accent-primary: #5c7cfa;
            --accent-gradient: linear-gradient(135deg, #5c7cfa 0%, #3b5bdb 100%);
            --accent-glow: 0 0 20px rgba(92, 124, 250, 0.3);
            
            /* UI Elements */
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-focus: rgba(92, 124, 250, 0.5);
            --card-radius: 16px;
            --sidebar-width: 280px;
            
            /* Functional Colors */
            --error: #ff6b6b;
            --success: #51cf66;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; 
            background: var(--bg-gradient); 
            color: var(--text-primary); 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }

        /* =========================================
           2. Auth Screen (Glass Card)
           ========================================= */
        #auth-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-gradient); z-index: 2000; 
            display: flex; justify-content: center; align-items: center; 
            backdrop-filter: blur(10px);
        }
        .auth-card { 
            background: rgba(30, 32, 40, 0.6); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 50px 40px; border-radius: 24px; width: 90%; max-width: 420px; 
            border: 1px solid var(--border-subtle); 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            animation: fadeInUp 0.6s ease-out;
        }
        
        /* ğŸ”¥ ë¡œê³  ìŠ¤íƒ€ì¼ ì¶”ê°€ (Auth) */
        .auth-logo {
            width: 80px; /* ë¡œê³  í¬ê¸° ì¡°ì ˆ */
            height: auto;
            margin: 0 auto 15px auto;
            display: block;
            filter: drop-shadow(0 0 10px rgba(92, 124, 250, 0.3)); /* ë¡œê³  ë°œê´‘ íš¨ê³¼ */
        }

        .auth-app-name { font-size: 2rem; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.5px; }
        .auth-app-name span { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-sub-title { font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 30px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase;}
        
        .auth-input { 
            width: 100%; padding: 16px; margin-bottom: 16px; 
            background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-subtle); 
            border-radius: 12px; color: white; outline: none; font-size: 1rem; 
            transition: all 0.3s ease; 
        }
        .auth-input:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(92, 124, 250, 0.15); background: rgba(0, 0, 0, 0.5); }
        
        .auth-btn { 
            width: 100%; padding: 16px; margin-top: 10px;
            background: var(--accent-gradient); color: white; 
            border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; 
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; 
            box-shadow: 0 4px 15px rgba(92, 124, 250, 0.3);
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(92, 124, 250, 0.4); }
        .auth-secondary-btn { margin-top: 15px; background: transparent; border: none; color: var(--text-dim); font-size: 0.9rem; cursor: pointer; transition: color 0.2s; }
        .auth-secondary-btn:hover { color: var(--text-primary); text-decoration: underline; }
        .auth-error { color: var(--error); font-size: 0.9rem; margin-bottom: 15px; display: none; background: rgba(255, 107, 107, 0.1); padding: 12px; border-radius: 8px; }

        /* =========================================
           3. Admin Modal (Modern Dashboard)
           ========================================= */
        #admin-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 3000; display: none; justify-content: center; align-items: center; 
        }
        .admin-content { 
            background: #1e1f24; width: 90%; max-width: 900px; max-height: 85vh; 
            border-radius: 20px; padding: 30px; overflow-y: auto; 
            border: 1px solid var(--border-subtle); box-shadow: 0 25px 50px rgba(0,0,0,0.6); 
        }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-subtle); }
        .status-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid var(--border-subtle); text-align: center; }
        .server-status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        .admin-table th { text-align: left; padding: 12px; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid var(--border-subtle); }
        .admin-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-primary); }
        .action-btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.2s; }
        .delete-user-btn { background: rgba(255, 107, 107, 0.15); color: #ff8787; }
        .delete-user-btn:hover { background: rgba(255, 107, 107, 0.25); }

        /* =========================================
           4. Layout (Sidebar & Main)
           ========================================= */
        #app-container { display: flex; width: 100%; height: 100%; display: none; position: relative; }
        
        /* Sidebar: Frosted Glass */
        #sidebar { 
            width: var(--sidebar-width); 
            background: var(--sidebar-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-subtle); 
            display: flex; flex-direction: column; 
            flex-shrink: 0; z-index: 1100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        #app-container.sidebar-closed #sidebar { margin-left: calc(var(--sidebar-width) * -1); }
        
        .sidebar-header { padding: 25px 20px; display: flex; align-items: center; justify-content: space-between; }
        
        /* ğŸ”¥ ë¡œê³  ìŠ¤íƒ€ì¼ ì¶”ê°€ (Sidebar) */
        .header-brand { 
            display: flex; 
            align-items: center; 
            gap: 10px; /* ë¡œê³ ì™€ ê¸€ì ì‚¬ì´ ê°„ê²© */
        }
        .sidebar-logo {
            width: 36px;
            height: auto;
        }

        .brand-text { font-size: 1.2rem; font-weight: 700; color: white; letter-spacing: -0.5px; }
        .brand-text span { color: var(--accent-primary); }
        
        .user-info { padding: 0 20px 15px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; border-bottom: 1px solid var(--border-subtle); }
        
        #new-chat-btn { 
            margin: 20px; padding: 12px; 
            background: rgba(255,255,255,0.05); color: var(--text-primary); 
            border: 1px solid var(--border-subtle); border-radius: 12px; 
            font-weight: 600; cursor: pointer; transition: all 0.2s; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #new-chat-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        #new-chat-btn span { font-size: 1.2rem; line-height: 1; color: var(--accent-primary); }

        #session-list { flex: 1; overflow-y: auto; padding: 0 12px; }
        .session-title {
            display: block;           /* ë¸”ë¡ ìš”ì†Œë¡œ ì„¤ì • */
            flex: 1;                  /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
            min-width: 0;             /* Flexbox ë‚´ì—ì„œ ë§ì¤„ì„í‘œ(...) ì‘ë™ì„ ìœ„í•œ í•„ìˆ˜ ì„¤ì • */
            
            white-space: nowrap;      /* ì¤„ë°”ê¿ˆ ê¸ˆì§€ (í•œ ì¤„ë¡œ í‘œì‹œ) */
            overflow: hidden;         /* ë„˜ì¹˜ëŠ” ê¸€ì ìˆ¨ê¹€ */
            text-overflow: ellipsis;  /* â˜… í•µì‹¬: ë„˜ì¹˜ëŠ” ë¶€ë¶„ì„ ... ìœ¼ë¡œ í‘œì‹œ */
            
            margin-right: 8px;        /* ì‚­ì œ(x) ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
            font-size: 0.9rem;        /* ê¸€ì í¬ê¸° ì¡°ì • (ì„ íƒì‚¬í•­) */
        }
        .session-item { 
            padding: 12px 16px; margin-bottom: 4px; border-radius: 10px; 
            cursor: pointer; color: var(--text-secondary); 
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem; transition: all 0.2s; overflow: hidden;
        }
        .session-item:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .session-item.active { 
            background: rgba(92, 124, 250, 0.15); color: var(--accent-primary); 
            font-weight: 600; 
        }
        .delete-btn { opacity: 0; transition: 0.2s; background: none; border: none; color: var(--text-dim); font-size: 1.1rem; padding: 4px; border-radius: 4px; cursor: pointer; }
        .session-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background: rgba(255,255,255,0.1); color: var(--error); }

        .sidebar-footer { padding: 20px; border-top: 1px solid var(--border-subtle); background: rgba(0,0,0,0.1); }
        
        /* Styled Select */
        #model-select { 
            width: 100%; padding: 10px 12px; background: rgba(0,0,0,0.3); 
            border: 1px solid var(--border-subtle); color: var(--text-secondary); 
            border-radius: 8px; outline: none; margin-bottom: 10px; cursor: pointer;
        }
        #model-select:focus { border-color: var(--accent-primary); }

        .admin-btn { width: 100%; padding: 10px; background: rgba(201, 42, 42, 0.2); color: #ff8787; border: 1px solid rgba(201, 42, 42, 0.3); border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
        .admin-btn:hover { background: rgba(201, 42, 42, 0.3); }

        .logout-btn { font-size: 0.85rem; color: var(--text-dim); background: none; border: none; padding: 0; cursor: pointer; text-decoration: underline; }
        .copyright { font-size: 0.75rem; color: #5c5f66; margin-top: 15px; text-align: center; opacity: 0.6; }

        /* =========================================
           5. Main Chat Area
           ========================================= */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        
        /* Header */
        #chat-header { 
            /* ê¸°ì¡´ ë†’ì´ 60px ëŒ€ì‹ , ëª¨ë°”ì¼ ì•ˆì „ ì˜ì—­(ë…¸ì¹˜)ì„ ë”í•œ ë†’ì´ë¡œ ê³„ì‚° */
            height: calc(60px + env(safe-area-inset-top)); 
            
            padding: 0 24px;
            
            /* ìƒë‹¨ íŒ¨ë”©ì— ì•ˆì „ ì˜ì—­ ì¶”ê°€ (ì´ê²Œ í•µì‹¬) */
            padding-top: env(safe-area-inset-top); 

            background: var(--header-glass); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-subtle); 
            display: flex; gap: 15px; align-items: center; z-index: 10; 
            position: absolute; top: 0; width: 100%;
        }
        #toggle-sidebar-btn { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 8px; transition: 0.2s; }
        #toggle-sidebar-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        #chat-container { 
            flex: 1; overflow-y: auto; 
            
            /* í—¤ë”ê°€ ì»¤ì§„ ë§Œí¼ ë³¸ë¬¸ ì‹œì‘ ìœ„ì¹˜ë„ ì•ˆì „ ì˜ì—­ë§Œí¼ ë” ë‚´ë ¤ì¤˜ì•¼ ê°€ë¦¬ì§€ ì•ŠìŒ */
            padding: calc(80px + env(safe-area-inset-top)) 20px 140px 20px;
            
            scroll-behavior: smooth; 
        }

        /* Message Bubbles */
        .message { 
            max-width: 800px; margin: 0 auto 20px; 
            display: flex; flex-direction: column; position: relative; 
            opacity: 0; animation: messageSlideIn 0.4s ease-out forwards;
        }
        .message.user { align-items: flex-end; }
        .message.model { align-items: flex-start; }

        .message .content { 
            padding: 12px 18px; 
            border-radius: 18px; 
            font-size: 1rem; 
            line-height: 1.75; 
            position: relative; 
            word-wrap: break-word; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* User Bubble: Gradient */
        .message.user .content {
            background: var(--accent-gradient);
            color: white;
            border-bottom-right-radius: 4px; 
            box-shadow: 0 4px 15px rgba(92, 124, 250, 0.2);
            
            /* ë‚´ìš©ë¬¼ ë°°ì¹˜ ì„¤ì • */
            display: flex; 
            flex-direction: column;
            transition: all 0.3s ease;
            
            /* ğŸ”¥ [ì‚­ì œë¨] padding-bottom: 0 !important;  <-- ì´ ì¤„ì„ ì§€ì› ìŠµë‹ˆë‹¤! */
            /* ì´ì œ ê¸°ë³¸ì ìœ¼ë¡œ ìœ„ì•„ë˜ íŒ¨ë”©ì´ 12pxì”© ë“¤ì–´ê°€ì„œ ê¸€ì”¨ê°€ ì •ì¤‘ì•™ì— ì˜µë‹ˆë‹¤. */
        }

        /* ğŸ”¥ [ì¶”ê°€] ë²„íŠ¼ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ í•˜ë‹¨ íŒ¨ë”© ì œê±° */
        .message.user .content.has-footer {
            padding-bottom: 0 !important;
        }

        /* (ì•„ë˜ ì½”ë“œëŠ” ê¸°ì¡´ ìœ ì§€) */

        /* â–¼â–¼â–¼ [ìˆ˜ì •] ë‚´ìš©ë¬¼ì´ ì ‘í˜”ì„ ë•Œ â–¼â–¼â–¼ */
        .message.user .content.collapsed .markdown-body {
            max-height: 200px;       
            overflow: hidden;
            
            /* ì•„ë˜ìª½ì„ ìì—°ìŠ¤ëŸ½ê²Œ íë¦¬ê²Œ ì²˜ë¦¬ */
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
        }

        /* AI Bubble: Glass Card */
        .message.model .content { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid var(--border-subtle);
            color: var(--text-primary); 
            border-bottom-left-radius: 4px;
            width: 100%; /* Full width for code blocks */
            padding-right: 40px; 
        }
        
        /* Markdown Styles */
        .message .content p { margin: 0 !important; }
        .message .content p + p { margin-top: 10px !important; }
        .message.model strong { color: #fff; font-weight: 700; }
        .message.model ul, .message.model ol { padding-left: 20px; margin: 8px 0; }
        .message.model li { margin-bottom: 4px; }
        
        /* Table Styles */
        .message.model table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 15px 0; border: 1px solid var(--border-subtle); border-radius: 8px; overflow: hidden; }
        .message.model th { background: rgba(255,255,255,0.05); padding: 10px; font-weight: 600; text-align: left; border-bottom: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .message.model td { padding: 10px; border-bottom: 1px solid var(--border-subtle); color: var(--text-primary); }
        .message.model tr:last-child td { border-bottom: none; }

        /* â–¼â–¼â–¼ [ìˆ˜ì •] ê¸´ ë©”ì‹œì§€(ì½”ë“œ) ì ‘ê¸° ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ (ê¹¨ì§ ë°©ì§€) â–¼â–¼â–¼ */
        .message.user .content.collapsed {
            max-height: 200px;       
            overflow: hidden;        
            
            /* ì ‘í˜”ì„ ë•ŒëŠ” ë²„íŠ¼ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ í•˜ë‹¨ ëª¨ì„œë¦¬ë¥¼ ì§ê°ìœ¼ë¡œ ë³€ê²½ */
            border-bottom-left-radius: 4px !important;
            border-bottom-right-radius: 4px !important; 
            
            /* í•˜ë‹¨ì´ ìì—°ìŠ¤ëŸ½ê²Œ íë ¤ì§€ëŠ” íš¨ê³¼ (ì„ íƒ ì‚¬í•­ - ê¹¨ì§ ë°©ì§€ ìœ„í•´ ì œê±°í•˜ê±°ë‚˜ ì•½í•˜ê²Œ) */
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }

        .message.user .content.collapsed {
            max-height: 200px;       
            overflow: hidden;        
            
            /* ì ‘í˜”ì„ ë•ŒëŠ” ë²„íŠ¼ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ í•˜ë‹¨ ëª¨ì„œë¦¬ë¥¼ ì§ê°ìœ¼ë¡œ ë³€ê²½ */
            border-bottom-left-radius: 4px !important;
            border-bottom-right-radius: 4px !important; 
            
            /* í•˜ë‹¨ì´ ìì—°ìŠ¤ëŸ½ê²Œ íë ¤ì§€ëŠ” íš¨ê³¼ (ì„ íƒ ì‚¬í•­ - ê¹¨ì§ ë°©ì§€ ìœ„í•´ ì œê±°í•˜ê±°ë‚˜ ì•½í•˜ê²Œ) */
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }

        /* â–¼â–¼â–¼ [ìˆ˜ì •] ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ (ë„ˆë¹„ ê³„ì‚° ë³´ì •) â–¼â–¼â–¼ */
        .read-more-btn {
            /* box-sizingì„ border-boxë¡œ í•˜ì—¬ íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
            box-sizing: border-box; 
            
            /* ì¢Œìš° íŒ¨ë”©(18px)ì„ ê³ ë ¤í•˜ì—¬ ê½‰ ì±„ìš°ê¸° */
            width: calc(100% + 36px); 
            margin-left: -18px;
            margin-right: -18px;
            
            background: var(--accent-gradient); /* ë§í’ì„ ê³¼ ë™ì¼ ë°°ê²½ */
            
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.3); 
            
            color: #fff;
            font-size: 0.85rem;
            font-weight: 700;
            padding: 12px 0; /* í„°ì¹˜í•˜ê¸° ì¢‹ê²Œ ì˜ì—­ í™•ì¥ */
            cursor: pointer;
            transition: 0.2s;
            margin-top: 5px; 
            
            border-bottom-left-radius: 18px;  
            border-bottom-right-radius: 4px;
            
            /* ê·¸ë¦¼ì ìœ ì§€ */
            box-shadow: 0 4px 15px rgba(92, 124, 250, 0.2); 
        }
        .read-more-btn:hover { filter: brightness(1.1); }
        
        /* í…ìŠ¤íŠ¸ ê°ì‹¸ëŠ” ë˜í¼ (JSì—ì„œ ì¶”ê°€ë¨) */
        .markdown-body {
            width: 100%;
        }

        /* Code Block */
        pre { 
            position: relative; /* â˜… í•µì‹¬: ë²„íŠ¼ì´ ì´ ìƒì ì•ˆì— ê°‡íˆë„ë¡ ê¸°ì¤€ì„ ì¡ìŒ */
            
            background: #15171a !important; 
            border-radius: 8px; 
            border: 1px solid var(--border-subtle); 
            margin: 12px 0; 
            padding: 12px; /* ì½”ë“œì™€ í…Œë‘ë¦¬ ì‚¬ì´ ì—¬ë°± ì¶”ê°€ (ê°€ë…ì„± UP) */
            overflow-x: auto; 
        }
        code { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; }

        /* Copy Buttons */
        .code-copy-btn, .msg-copy-btn { 
            position: absolute; top: 8px; right: 8px; 
            background: rgba(255,255,255,0.1); border: none; 
            border-radius: 6px; padding: 6px; 
            color: var(--text-secondary); cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .code-copy-btn:hover, .msg-copy-btn:hover { background: var(--accent-primary); color: white; }
        .msg-copy-btn { top: 10px; right: 10px; opacity: 0; }
        .message:hover .msg-copy-btn { opacity: 1; }

        /* =========================================
           6. Floating Input Area (Key Change)
           ========================================= */
        #input-area { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            padding: 20px 0 40px 0; 
            display: flex; justify-content: center; z-index: 20; 
            background: linear-gradient(to top, var(--bg-gradient) 20%, transparent 100%);
            pointer-events: none; /* Let clicks pass through transparent part */
        }
        .input-wrapper { 
            pointer-events: auto;
            position: relative; width: 800px; max-width: 90%; 
            background: var(--input-glass); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border-subtle); 
            border-radius: 24px; 
            display: flex; align-items: center; padding: 6px 6px 6px 16px; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .input-wrapper:focus-within { 
            border-color: rgba(92, 124, 250, 0.4); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.4), var(--accent-primary);
            transform: translateY(-2px);
        }
        
        #mode-select {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
            color: var(--text-secondary); border-radius: 18px; 
            padding: 0 12px; height: 32px; font-size: 0.8rem; font-weight: 600;
            outline: none; margin-right: 8px; cursor: pointer; appearance: none;
            transition: 0.2s; text-align: center;
        }
        #mode-select:hover { color: var(--accent-primary); background: rgba(92, 124, 250, 0.1); }
        #mode-select option { background: #25262b; }

        /* â–¼â–¼â–¼ [ìˆ˜ì • í›„] ì•„ë˜ ì½”ë“œë¡œ ë®ì–´ì”Œìš°ì„¸ìš” â–¼â–¼â–¼ */
        #input-box { 
            flex: 1; 
            background: transparent; 
            border: none; 
            
            /* í•µì‹¬ ìˆ˜ì •: paddingì„ ëŠ˜ë ¤ì„œ í…ìŠ¤íŠ¸ê°€ ë°•ìŠ¤ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ë„ë¡ ì¡°ì • */
            padding: 14px 10px; 
            
            color: white; 
            font-size: 1rem; 
            resize: none; 
            overflow-y: hidden; 
            max-height: 150px; 
            outline: none; 
            font-family: 'Pretendard', sans-serif; 
            line-height: 1.5; 
            
            /* í•µì‹¬ ìˆ˜ì •: ì´ˆê¸° ë†’ì´ë¥¼ í•œ ì¤„ ë†’ì´ì— ë§ê²Œ ìë™ ì„¤ì • */
            height: 52px; 
        }
        
        #send-btn { 
            background: var(--accent-gradient); border: none; color: white; 
            cursor: pointer; width: 40px; height: 40px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            transition: 0.2s; box-shadow: 0 4px 10px rgba(92, 124, 250, 0.3);
            margin-left: 5px; flex-shrink: 0;
        }
        #send-btn:hover { transform: scale(1.05); box-shadow: 0 6px 15px rgba(92, 124, 250, 0.5); }
        #send-btn:active { transform: scale(0.95); }

        /* =========================================
           7. Animations & Effects
           ========================================= */
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes shine {
            to { background-position: 200% center; }
        }

        /* Shining Text */
        .shining-text {
            font-weight: 800; font-size: 1.1rem;
            background: linear-gradient(to right, #fff 20%, #a5b4fc 40%, #a5b4fc 60%, #fff 80%);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 4s linear infinite;
        }

        /* Typing Indicator */
        .typing-indicator { display: flex; gap: 6px; padding: 10px 0; align-items: center; }
        .typing-dot { width: 6px; height: 6px; background: var(--text-secondary); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        /* Snow Effect */
        #snow-header-snow { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1; }
        .snowflake { position: absolute; top: -10px; background: white; border-radius: 50%; filter: blur(1px); animation: snowfall linear infinite; }
        @keyframes snowfall {
            0% { transform: translateY(0) translateX(0); opacity: 0.6; }
            100% { transform: translateY(60px) translateX(20px) rotate(360deg); opacity: 0; }
        }
        
        /* Mobile Adjustments */
        #mobile-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1050; display: none; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(4px); }
        
        @media (max-width: 768px) {
            #sidebar { position: fixed; height: 100%; width: 85%; max-width: 320px; transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            #app-container.mobile-sidebar-open #sidebar { transform: translateX(0); }
            #app-container.mobile-sidebar-open #mobile-overlay { display: block; opacity: 1; }
            #app-container.sidebar-closed #sidebar { margin-left: 0; } /* Reset for mobile logic */
            
            .input-wrapper { width: 92%; padding: 4px 4px 4px 12px; border-radius: 20px; }
            #chat-container { padding: 70px 15px 120px 15px; }
            .message .content { font-size: 0.95rem; padding: 10px 15px; }
            #chat-header { padding: 0 15px; }
        }

        /* ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë©”ë‰´ (ì…ë ¥ì°½ ìœ„ì— ë‘¥ë‘¥ ë– ìˆëŠ” ë ˆì´ì–´) */
        #slash-menu {
            position: absolute; bottom: 80px; left: 16px;
            background: #25262b; border: 1px solid var(--border-subtle);
            border-radius: 12px; width: 260px; display: none;
            flex-direction: column; overflow: hidden; z-index: 100;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); padding: 5px;
        }
        .slash-item {
            padding: 10px 12px; cursor: pointer; color: var(--text-secondary);
            font-size: 0.9rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        .slash-item:hover, .slash-item.selected { background: var(--accent-primary); color: white; }
        .slash-cmd { font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .slash-desc { font-size: 0.75rem; opacity: 0.8; }
    
        /* â–¼â–¼â–¼ [ë³µë¶™] ë°”ë‚˜ë‚˜ ëª¨ë“œ ë””ìì¸ â–¼â–¼â–¼ */
        body.banana-mode {
            --bg-gradient: linear-gradient(135deg, #181602 0%, #2e2a05 100%);
            --sidebar-glass: rgba(26, 23, 5, 0.85);
            --header-glass: rgba(255, 215, 0, 0.05);
            --accent-primary: #fcc419;
            --accent-gradient: linear-gradient(135deg, #fcc419 0%, #ffec99 100%);
            --text-primary: #fff9db;
        }
        body.banana-mode .message.user .content { color: #212529; font-weight: bold; }
        #banana-btn {
            background: none; border: none; font-size: 1.4rem; cursor: pointer;
            margin-right: 8px; filter: grayscale(100%); opacity: 0.5; transition: 0.3s;
        }
        #banana-btn:hover, #banana-btn.active { filter: grayscale(0%); opacity: 1; transform: scale(1.2); }
        /* â–²â–²â–² [ë³µë¶™] ì—¬ê¸°ê¹Œì§€ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ [ë³µë¶™] ì»¤ìŠ¤í…€ ëª¨ë‹¬ & í† ìŠ¤íŠ¸ ì•Œë¦¼ ë””ìì¸ (ì¤‘ì•™ ì •ë ¬ & Luxury Dark) â–¼â–¼â–¼ */

        /* 1. ì»¤ìŠ¤í…€ ëª¨ë‹¬ (Confirm ì°½) */
        #custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            z-index: 9999; display: none; justify-content: center; align-items: center;
            animation: fadeIn 0.3s ease-out;
        }
        .custom-modal-box {
            background: rgba(30, 32, 40, 0.95); border: 1px solid var(--border-subtle);
            border-radius: 20px; padding: 30px; width: 90%; max-width: 400px;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            transform: scale(0.9); animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        .modal-icon { font-size: 3.5rem; margin-bottom: 15px; display: block; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
        .modal-text { color: var(--text-primary); font-size: 1.1rem; margin-bottom: 25px; line-height: 1.5; word-break: keep-all;}
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .modal-btn {
            flex: 1; padding: 12px; border: none; border-radius: 12px;
            font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.95rem;
        }
        .btn-cancel { background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); }
        .btn-cancel:hover { background: rgba(255, 255, 255, 0.15); color: white; }
        .btn-confirm { background: var(--accent-gradient); color: white; box-shadow: 0 4px 15px rgba(92, 124, 250, 0.3); }
        .btn-confirm:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(92, 124, 250, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #fa5252 100%); color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4); }

        /* 2. í† ìŠ¤íŠ¸ ì•Œë¦¼ (Alert ëŒ€ì²´) */
        #toast-container {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            z-index: 10000; pointer-events: none; width: 100%; display: flex; flex-direction: column; align-items: center;
        }
        .toast {
            background: rgba(30, 32, 40, 0.95); border: 1px solid var(--border-subtle);
            color: white; padding: 12px 24px; border-radius: 50px;
            margin-top: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            display: flex; align-items: center; gap: 10px; pointer-events: auto;
            opacity: 0; transform: translateY(20px);
            animation: toastUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes popIn { to { transform: scale(1); } }
        @keyframes toastUp { to { opacity: 1; transform: translateY(0); } }
        /* â–²â–²â–² [ë³µë¶™] ì—¬ê¸°ê¹Œì§€ â–²â–²â–² */

        /* â–¼â–¼â–¼ [ë³µë¶™] ì±„íŒ…ì°½ ì´ë¯¸ì§€ ì˜ˆì˜ê²Œ ë§Œë“¤ê¸° â–¼â–¼â–¼ */

        /* 1. ì´ë¯¸ì§€ í¬ê¸° ìë™ ì¡°ì ˆ ë° ë””ìì¸ */
        .message .content img {
            max-width: 100%;       /* ë§í’ì„  ë„ˆë¹„ë¥¼ ë„˜ì§€ ì•Šê²Œ */
            height: auto;          /* ë¹„ìœ¨ ìœ ì§€ */
            border-radius: 12px;   /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            margin-top: 10px;      /* í…ìŠ¤íŠ¸ì™€ ê°„ê²© */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); /* ê·¸ë¦¼ì íš¨ê³¼ */
            display: block;        /* ì¤„ë°”ê¿ˆ */
            cursor: pointer;       /* í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
            transition: transform 0.2s; /* ë¶€ë“œëŸ¬ìš´ íš¨ê³¼ */
        }

        /* 2. ì´ë¯¸ì§€ ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ì‚´ì§ ì»¤ì§€ê¸° */
        .message .content img:hover {
            transform: scale(1.02);
        }

        /* 3. ëª¨ë°”ì¼ì—ì„œëŠ” ê½‰ ì°¨ê²Œ */
        @media (max-width: 768px) {
            .message .content img {
                width: 100%;       /* ëª¨ë°”ì¼ì€ ê°€ë¡œ ê½‰ ì°¨ê²Œ */
                border-radius: 8px;
            }
        }
        /* â–²â–²â–² [ë³µë¶™] ì—¬ê¸°ê¹Œì§€ â–²â–²â–² */
    
        /* â–¼â–¼â–¼ [ë³µë¶™] ë°”ë‚˜ë‚˜ ëª¨ë“œ: ê³ í€„ë¦¬í‹° ì±„íŒ…ì°½ í…Œë‘ë¦¬ íš¨ê³¼ â–¼â–¼â–¼ */
        body.banana-mode .input-wrapper {
            /* 1. ì§„í•œ ì˜ë¡œìš° ê³¨ë“œ í…Œë‘ë¦¬ (2pxë¡œ ë‘ê»ê²Œ) */
            border: 2px solid #fcc419 !important; 
            
            /* 2. ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë°œê´‘ íš¨ê³¼ (Glow) 
            - ì²« ë²ˆì§¸: ì™¸ë¶€ë¡œ í¼ì§€ëŠ” ì§„í•œ ë¹›
            - ë‘ ë²ˆì§¸: ë‚´ë¶€ë¡œ ìŠ¤ë©°ë“œëŠ” ì€ì€í•œ ë¹›
            */
            box-shadow: 
                0 0 30px rgba(252, 196, 25, 0.4), 
                inset 0 0 15px rgba(252, 196, 25, 0.1) !important;
            
            /* 3. í™œì„±í™” ì‹œ ì‚´ì§ ë– ì˜¤ë¥´ëŠ” ëŠë‚Œ */
            transform: translateY(-4px); 
            
            /* 4. ë°°ê²½ì„ ì•½ê°„ ë” ì–´ë‘¡ê²Œ í•´ì„œ ë…¸ë€ìƒ‰ì„ ê°•ì¡° */
            background: rgba(40, 35, 10, 0.9) !important;
        }

        /* ë°”ë‚˜ë‚˜ ëª¨ë“œì¼ ë•Œ ì „ì†¡ ë²„íŠ¼ë„ ê¹”ë§ì¶¤ */
        body.banana-mode #send-btn {
            background: linear-gradient(135deg, #fcc419 0%, #ff922b 100%) !important;
            color: #212529 !important; /* ì•„ì´ì½˜ ê²€ì •ìƒ‰ */
            box-shadow: 0 0 15px rgba(252, 196, 25, 0.6) !important;
        }
        /* â–²â–²â–² [ë³µë¶™] ì—¬ê¸°ê¹Œì§€ â–²â–²â–² */

        /* â–¼â–¼â–¼ [ì¶”ê°€] ë¯¸ë‹ˆ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ â–¼â–¼â–¼ */
        .mini-preview-item {
            position: relative;
            width: 40px; height: 40px; /* ì‘ê²Œ ê³ ì • */
            flex-shrink: 0;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            overflow: hidden;
            background: #333;
            display: flex; align-items: center; justify-content: center;
        }
        .mini-preview-item img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .mini-preview-item .file-ext {
            font-size: 0.6rem; color: #fff; font-weight: bold;
        }
        .mini-preview-close {
            position: absolute; top: 0; right: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            color: white; border: none;
            display: none; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1rem;
        }
        .mini-preview-item:hover .mini-preview-close { display: flex; } /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚­ì œ ë²„íŠ¼ ëœ¸ */

    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card" id="login-form">
            <div class="auth-header">
                <img src="logo.png" class="auth-logo" alt="AssistBerry Logo">
                <div class="auth-app-name">AssistBerry <span>AI</span></div>
            </div>
            <div class="auth-sub-title">System Access</div>
            <div class="auth-error" id="login-error"></div>
            <input type="text" id="login-id" class="auth-input" placeholder="Account ID" onkeydown="handleAuthKey(event, 'login')">
            <input type="password" id="login-pw" class="auth-input" placeholder="Password" onkeydown="handleAuthKey(event, 'login')">
            <button class="auth-btn" onclick="login()">Sign In</button>
            <button class="auth-secondary-btn" onclick="toggleAuth('signup')">Create Account</button>
        </div>
        <div class="auth-card" id="signup-form" style="display:none;">
            <div class="auth-header">
                <img src="logo.png" class="auth-logo" alt="AssistBerry Logo">
                <div class="auth-app-name">AssistBerry <span>AI</span></div>
            </div>
            <div class="auth-sub-title">New Registration</div>
            <div class="auth-error" id="signup-error"></div>
            <input type="text" id="signup-id" class="auth-input" placeholder="Desired ID" onkeydown="handleAuthKey(event, 'signup')">
            <input type="password" id="signup-pw" class="auth-input" placeholder="Desired Password" onkeydown="handleAuthKey(event, 'signup')">
            <button class="auth-btn" onclick="register()">Submit Request</button>
            <button class="auth-secondary-btn" onclick="toggleAuth('login')">Return to Login</button>
        </div>
    </div>

    <div id="admin-modal">
        <div class="admin-content">
            <div class="admin-header">
                <h2 style="margin:0; color:white;">System Dashboard</h2>
                <button onclick="document.getElementById('admin-modal').style.display='none'" class="action-btn" style="background:#343a40; color:white; padding:8px 16px;">Close</button>
            </div>
            <div class="server-status-grid">
                <div class="status-card"><div class="status-label" style="color:var(--text-dim); font-size:0.8rem;">MEMORY</div><div class="status-value" id="status-mem" style="font-size:1.5rem; font-weight:700; color:white; margin:5px 0;">-</div><div class="status-sub" id="status-mem-sub" style="color:var(--success); font-size:0.8rem;">-</div></div>
                <div class="status-card"><div class="status-label" style="color:var(--text-dim); font-size:0.8rem;">CPU LOAD</div><div class="status-value" id="status-load" style="font-size:1.5rem; font-weight:700; color:white; margin:5px 0;">-</div><div class="status-sub" id="status-load-pct" style="color:var(--accent-primary); font-size:0.8rem;">-</div></div>
                <div class="status-card"><div class="status-label" style="color:var(--text-dim); font-size:0.8rem;">STORAGE</div><div class="status-value" id="status-disk" style="font-size:1.5rem; font-weight:700; color:white; margin:5px 0;">-</div><div class="status-sub" id="status-disk-sub" style="color:var(--text-secondary); font-size:0.8rem;">-</div></div>
            </div>
            <div class="uptime-bar" id="status-uptime" style="text-align:center; color:var(--text-dim); font-size:0.9rem; margin-bottom:30px;">Uptime: -</div>
            
            <div style="margin-bottom:30px; border-top:1px solid var(--border-subtle); padding-top:20px;">
                <h4 style="margin:0 0 15px 0; color:var(--text-secondary);">Knowledge Injection</h4>
                <input type="text" id="ingest-title" class="auth-input" placeholder="Subject Title">
                <textarea id="ingest-content" class="auth-input" style="height:100px; resize:vertical;" placeholder="Knowledge Content..."></textarea>
                <button class="auth-btn" onclick="ingestKnowledge()" style="margin-top:0; width:auto; padding:10px 24px;">Inject Data</button>
            </div>

            <h3 style="margin-top:20px; color:white; font-size:1.1rem;">Stored Knowledge Base</h3>
            <div style="max-height:300px; overflow-y:auto; border:1px solid var(--border-subtle); border-radius:8px;">
                <table class="admin-table"><thead><tr><th>ID</th><th>Title</th><th>Date</th><th>Action</th></tr></thead><tbody id="admin-knowledge-list"></tbody></table>
            </div>

            <h3 style="margin-top:30px; color:white; font-size:1.1rem;">User Management</h3>
             <div style="max-height:300px; overflow-y:auto; border:1px solid var(--border-subtle); border-radius:8px;">
                <table class="admin-table"><thead><tr><th>User</th><th>Status</th><th>Pro</th><th>Action</th></tr></thead><tbody id="admin-user-list"></tbody></table>
            </div>
            <button class="shutdown-btn" onclick="shutdownServer()" style="width:100%; margin-top:30px; background:rgba(255,107,107,0.1); color:#ff8787; border:1px solid #ff8787; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">â» Emergency Shutdown</button>
        </div>
    </div>

    <div id="mobile-overlay" onclick="toggleSidebar()"></div>

    <div id="app-container">
        <div id="sidebar">
            <div class="sidebar-header">
                <div class="header-brand">
                    <img src="logo.png" class="sidebar-logo" alt="AssistBerry Logo">
                    <span class="brand-text">AssistBerry <span>AI</span></span>
                </div>
                <button id="mobile-close-btn" onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer; display:none;">âœ•</button>
            </div>
            
            <div class="user-info" id="user-display-name"></div>
            
            <button id="new-chat-btn" onclick="handleNewChat()">
                <span>+</span> New Analysis
            </button>
            
            <div id="session-list"></div>
            
            <div class="sidebar-footer">
                <button class="admin-btn" onclick="clearAllSessions()" style="background:rgba(255, 107, 107, 0.1); color:#ff8787; border-color:rgba(255, 107, 107, 0.2); margin-bottom:10px;">
                    ğŸ—‘ï¸ Clear All History
                </button>
                <button class="admin-btn" id="admin-panel-btn" onclick="openAdminPanel()" style="display:none;">Admin Dashboard</button>
                
                <select id="model-select">
                    <option value="gemini-2.5-flash" selected>âš¡ Gemini 2.5 Flash (Speed)</option>
                    <option value="gemini-3-pro">ğŸ§  Gemini 3 Pro (Expert)</option>
                </select>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <button class="logout-btn" onclick="logout()">Log Out</button>
                    <a href="mailto:kimsangho0816@gmail.com" style="color:var(--text-dim); text-decoration:none; font-size:0.75rem;">Contact Dev</a>
                </div>
                <div class="copyright">Engineered by sanghokim</div>
            </div>
        </div>

        <div id="main">
            <div id="chat-header">
                <div class="snow-container" id="snow-header-snow"></div>
                
                <button id="toggle-sidebar-btn" onclick="event.stopPropagation(); toggleSidebar()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                
                <span class="shining-text">AI Knowledge Partner</span>
            </div>
            
            <div id="chat-container"></div>
            
            <div id="input-area">
                <div class="input-wrapper">
                    <select id="mode-select">
                        <option value="general" selected>General</option>
                        <option value="tech">Tech</option>
                        <option value="business">Biz</option>
                        <option value="custom">Custom</option>
                    </select>

                    <div id="slash-menu"></div>
                    <button id="banana-btn" onclick="toggleBananaMode()" style="display:none;">ğŸŒ</button>
                    <input type="file" id="file-upload-input" multiple style="display: none;" onchange="handleFileSelect(event)">
                    <button id="attach-btn" onclick="document.getElementById('file-upload-input').click()" 
                        style="background:none; border:none; color:var(--text-secondary); cursor:pointer; padding:5px 8px; display:flex; align-items:center; transition:0.2s;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    </button>
                    <div id="mini-preview-container" style="display:none; align-items:center; gap:5px; margin-right:5px; max-width:150px; overflow-x:auto;">
                    </div>
                    <textarea id="input-box" placeholder="Ask anything..."></textarea>
                    <button id="send-btn">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>

            </div>
        </div>
    </div>

<div id="cleanup-modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px);">
        <div class="custom-modal-box" style="max-width: 450px; text-align: center;">
            <div style="font-size:3.5rem; margin-bottom:10px;">ğŸ§¹</div>
            <h2 style="color:white; margin:0 0 10px;">ì €ì¥ê³µê°„ ìµœì í™” ì•Œë¦¼</h2>
            <p style="color:var(--text-secondary); font-size:0.95rem; line-height:1.5;">
                ì„œë²„ ì„±ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ <strong>1ê°œì›”ì´ ì§€ë‚œ ëŒ€í™”</strong>ë¥¼ ì •ë¦¬í•´ì£¼ì„¸ìš”.<br>
                <span style="font-size:0.85rem; opacity:0.7;">(ì˜¤ë˜ëœ ë°ì´í„°ëŠ” DB ì†ë„ ì €í•˜ì˜ ì›ì¸ì´ ë©ë‹ˆë‹¤.)</span>
            </p>
            
            <div style="background:rgba(0,0,0,0.3); border:1px solid var(--border-subtle); border-radius:12px; padding:15px; margin:20px 0; text-align:left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.85rem; color:var(--text-dim); font-weight:bold;">
                    <span>ì‚­ì œ ëŒ€ìƒ (1ê°œì›” ê²½ê³¼)</span>
                    <span id="cleanup-total-count" style="color:var(--error);">0ê±´</span>
                </div>
                <ul id="cleanup-list" style="margin:0; padding:0; list-style:none; max-height:150px; overflow-y:auto; font-size:0.9rem;">
                </ul>
            </div>

            <p id="cleanup-admin-note" style="display:none; font-size:0.8rem; color:#69db7c; margin-bottom:20px; background:rgba(81, 207, 102, 0.1); padding:8px; border-radius:6px;">
                âœ… ê´€ë¦¬ì(Admin) ë°ì´í„°ëŠ” ê²€ìƒ‰ ì—”ì§„ì— ìë™ ë°±ì—…ë©ë‹ˆë‹¤.
            </p>

            <div class="modal-btns" style="flex-direction:column; gap:10px;">
                <button onclick="performCleanup()" class="modal-btn btn-confirm" style="width:100%; padding:14px; font-size:1rem;">
                    ë„¤, ëª¨ë‘ ì •ë¦¬í•©ë‹ˆë‹¤ (Clean All)
                </button>
                <button onclick="closeCleanupModal()" class="modal-btn" style="width:100%; background:transparent; color:var(--text-dim); border:1px solid var(--border-subtle);">
                    ë‚˜ì¤‘ì— í•˜ê¸° (ì·¨ì†Œ)
                </button>
            </div>
        </div>
    </div>

    <div id="custom-modal-overlay">
        <div class="custom-modal-box">
            <span class="modal-icon" id="modal-icon">âš ï¸</span>
            <div class="modal-text" id="modal-msg">Are you sure?</div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn btn-confirm" id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        let currentUser = null;
        let currentSessionId = null;
        let isSending = false; 
        let isComposing = false; 
        
        // Mobile Check
        const isMobile = () => window.innerWidth <= 768;

        marked.setOptions({ breaks: true, gfm: true });
        
        if(isMobile()) document.getElementById('mobile-close-btn').style.display = 'block';

        async function safeCopy(text, btn) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus(); textArea.select();
                    try { document.execCommand('copy'); } catch (err) {}
                    document.body.removeChild(textArea);
                }
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#51cf66" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                setTimeout(() => btn.innerHTML = originalHtml, 1500);
            } catch (e) { console.error(e); }
        }

        // â–¼â–¼â–¼ [ë³µë¶™] ì»¤ìŠ¤í…€ íŒì—… ì‹œìŠ¤í…œ & ì „ì²´ ì‚­ì œ ë¡œì§ â–¼â–¼â–¼

        // 1. í† ìŠ¤íŠ¸ ì•Œë¦¼ (ê¸°ì¡´ alert ëŒ€ì‹  ì‚¬ìš©)
        function showToast(msg, icon = 'âœ…') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span style="font-size:1.2rem">${icon}</span> <span style="font-weight:500;">${msg}</span>`;
            container.appendChild(toast);
            
            // 3ì´ˆ ë’¤ ì‚¬ë¼ì§
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 2. ì»¤ìŠ¤í…€ ì»¨íŒ ì°½ (ê¸°ì¡´ confirm ëŒ€ì‹  ì‚¬ìš©)
        // ì‚¬ìš©ë²•: showConfirm("ì§ˆë¬¸ë‚´ìš©", () => { ì‹¤í–‰í• í•¨ìˆ˜() }, "ì•„ì´ì½˜", "ë²„íŠ¼ìƒ‰(ì˜µì…˜)")
        function showConfirm(msg, onConfirm, icon = 'ğŸ¤”', btnClass = 'btn-confirm') {
            const overlay = document.getElementById('custom-modal-overlay');
            document.getElementById('modal-msg').innerHTML = msg.replace(/\n/g, '<br>');
            document.getElementById('modal-icon').innerText = icon;
            
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.className = `modal-btn ${btnClass}`; // ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (íŒŒë‘/ë¹¨ê°•)
            
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆê±° ë“±ë¡ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            
            newBtn.onclick = () => {
                onConfirm();
                closeModal();
            };
            
            overlay.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('custom-modal-overlay').style.display = 'none';
        }

        // 3. [ê¸°ëŠ¥] ì „ì²´ ê¸°ë¡ ì‚­ì œ í•¨ìˆ˜ (API í˜¸ì¶œ)
        // â–¼â–¼â–¼ [ìˆ˜ì •] clearAllSessions í•¨ìˆ˜ ë‚´ë¶€ (ì£¼ì†Œ ë³€ê²½) â–¼â–¼â–¼
        async function clearAllSessions() {
            showConfirm(
                "ëª¨ë“  ëŒ€í™” ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 
                async () => {
                    try {
                        // ğŸ”¥ ì—¬ê¸° ì£¼ì†Œë¥¼ '/api/sessions/clear-all'ë¡œ ë³€ê²½! (ê¸°ì¡´ 'all' -> 'clear-all')
                        const res = await fetch('/api/sessions/clear-all', { method: 'DELETE' });
                        const data = await res.json();
                        
                        if(data.success) {
                            showToast("ëª¨ë“  ëŒ€í™”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "ğŸ—‘ï¸");
                            currentSessionId = null;
                            document.getElementById('chat-container').innerHTML = '';
                            await loadSessions(); // ëª©ë¡ ê°±ì‹ 
                        } else {
                            showToast("ì‚­ì œ ì‹¤íŒ¨: " + (data.error || "Unknown Error"), "âŒ");
                        }
                    } catch(e) { console.error(e); }
                },
                "ğŸ”¥", "btn-danger"
            );
        }
        // â–²â–²â–² [ìˆ˜ì •] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²

        function toggleAuth(mode) {
            document.getElementById('login-form').style.display = mode === 'login' ? 'block' : 'none';
            document.getElementById('signup-form').style.display = mode === 'signup' ? 'block' : 'none';
        }
        function handleAuthKey(e, type) { if (e.key === 'Enter') type === 'login' ? login() : register(); }

        async function register() {
            const res = await fetch('/api/auth/register', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username:document.getElementById('signup-id').value, password:document.getElementById('signup-pw').value}) });
            const data = await res.json();
            if(data.success) { alert(data.message); toggleAuth('login'); } else { alert(data.error); }
        }
        async function login() {
            const res = await fetch('/api/auth/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username:document.getElementById('login-id').value, password:document.getElementById('login-pw').value}) });
            const data = await res.json();
            if(data.success) { currentUser = data.user; initApp(); } else { document.getElementById('login-error').innerText = data.error; document.getElementById('login-error').style.display='block'; }
        }
        async function logout() { await fetch('/api/auth/logout', {method:'POST'}); location.reload(); }

        // â–¼â–¼â–¼ [ìˆ˜ì •] initApp í•¨ìˆ˜: ê´€ë¦¬ì ë²„íŠ¼ í‘œì‹œ ë¡œì§ ì¶”ê°€ â–¼â–¼â–¼
        function initApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            if (isMobile()) document.getElementById('app-container').classList.remove('mobile-sidebar-open');
            else document.getElementById('app-container').classList.add('sidebar-closed'); 
            
            document.getElementById('user-display-name').innerText = `Welcome, ${currentUser.username}`;
            
            // 1. Admin íŒ¨ë„ ë²„íŠ¼ ë° ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ (í•µì‹¬ ìˆ˜ì •!)
            if (currentUser.role === 'admin') {
                // (1) íŒì—…ì°½ ë‚´ ê´€ë¦¬ì ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
                document.getElementById('cleanup-admin-note').style.display = 'block';
                
                // (2) ğŸ”¥ [ëˆ„ë½ë˜ì—ˆë˜ ë¶€ë¶„] ì‚¬ì´ë“œë°”ì˜ 'Admin Dashboard' ë²„íŠ¼ í‘œì‹œ
                document.getElementById('admin-panel-btn').style.display = 'block'; 
            } else {
                // ì¼ë°˜ ìœ ì €ëŠ” ìˆ¨ê¹€ (í˜¹ì‹œ ëª¨ë¥¼ ì´ˆê¸°í™”)
                document.getElementById('admin-panel-btn').style.display = 'none';
            }
            
            // 2. ë°”ë‚˜ë‚˜ ë²„íŠ¼ í‘œì‹œ ë¡œì§
            if (currentUser.allowImage || currentUser.role === 'admin' || currentUser.username === 'shoo.kim') {
                document.getElementById('banana-btn').style.display = 'block';
            } else {
                document.getElementById('banana-btn').style.display = 'none';
            }
            

            
            // 3. ëª¨ë¸ ì„ íƒì°½ ì ê¸ˆ ì²˜ë¦¬
            const modelSelect = document.getElementById('model-select');
            const proOpts = [modelSelect.querySelector('option[value="gemini-3-pro"]')];
            if(!currentUser.allowPro) {
                proOpts.forEach(opt => { opt.disabled = true; opt.innerText += " (Locked)"; });
                modelSelect.value = 'gemini-2.5-flash';
            }

            // 4. ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
            loadSessions().then(has => { 
                if(!has) createNewSession(); 
                else {
                    const first = document.querySelector('.session-item');
                    if(first) loadMessages(first.getAttribute('data-id'));
                }
                // â–¼â–¼â–¼ [ì¶”ê°€] ë¡œê·¸ì¸ 1.5ì´ˆ ë’¤ì— ì •ë¦¬ íŒì—… ì²´í¬ â–¼â–¼â–¼
                setTimeout(checkExpiredSessions, 1500);
            });
        }
        // â–²â–²â–² [êµì²´] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²

        function toggleSidebar() {
            const app = document.getElementById('app-container');
            if (isMobile()) {
                app.classList.toggle('mobile-sidebar-open');
            } else {
                app.classList.toggle('sidebar-closed');
            }
        }

        document.getElementById('main').addEventListener('click', () => {
            if(isMobile() && document.getElementById('app-container').classList.contains('mobile-sidebar-open')) {
                toggleSidebar();
            }
        });

        async function handleNewChat() {
            await createNewSession();
            if (isMobile()) {
                document.getElementById('app-container').classList.remove('mobile-sidebar-open');
            }
        }

        const chatContainer = document.getElementById('chat-container');
        const inputBox = document.getElementById('input-box');
        
        async function loadSessions() {
            const list = document.getElementById('session-list');
            list.innerHTML = '';
            
            try {
                const res = await fetch('/api/sessions');
                if(!res.ok) return false;
                const sessions = await res.json();
                
                if(sessions.length === 0) return false;

                // ê·¸ë£¹í•‘ ë¡œì§
                const now = new Date();
                const groups = { 'Today': [], 'Last 7 Days': [], 'Older': [] };
                
                sessions.forEach(s => {
                    // s.created_atì´ DBì— ìˆë‹¤ê³  ê°€ì • (ì—†ìœ¼ë©´ s.id ë“±ìœ¼ë¡œ ì¶”ì • í•„ìš”)
                    // ì—¬ê¸°ì„  í¸ì˜ìƒ ëª¨ë‘ Todayë¡œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆìœ¼ë‹ˆ DB ì¿¼ë¦¬ì—ì„œ created_at ê¼­ ê°€ì ¸ì˜¤ì„¸ìš”.
                    const date = new Date(s.created_at || now); 
                    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                    
                    if(diffDays === 0) groups['Today'].push(s);
                    else if(diffDays <= 7) groups['Last 7 Days'].push(s);
                    else groups['Older'].push(s);
                });

                // ë Œë”ë§
                Object.keys(groups).forEach(label => {
                    if(groups[label].length > 0) {
                        const header = document.createElement('div');
                        header.innerText = label;
                        header.style.cssText = 'padding:15px 12px 5px; font-size:0.75rem; color:var(--text-dim); font-weight:700; text-transform:uppercase; letter-spacing:0.5px;';
                        list.appendChild(header);

                        groups[label].forEach(s => {
                            const div = document.createElement('div');
                            div.className = `session-item ${s.id == currentSessionId ? 'active' : ''}`;
                            div.setAttribute('data-id', s.id);
                            div.innerHTML = `<span class="session-title">${s.title}</span><button class="delete-btn">Ã—</button>`;
                            div.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); deleteSession(s.id); };
                            div.onclick = () => { loadMessages(s.id); if(isMobile()) toggleSidebar(); };
                            list.appendChild(div);
                        });
                    }
                });
                return true;
            } catch(e) { return false; }
        }

        // â–¼â–¼â–¼ [êµì²´] ìƒˆ ì„¸ì…˜ ìƒì„± í•¨ìˆ˜ (ë°”ë‚˜ë‚˜ ëª¨ë“œ ìë™ ì´ˆê¸°í™” ì¶”ê°€) â–¼â–¼â–¼
        async function createNewSession() {
            // ğŸ”¥ [ì¶”ê°€ëœ ë¶€ë¶„] ìƒˆ ì±„íŒ… ì‹œì‘ ì‹œ ë°”ë‚˜ë‚˜ ëª¨ë“œë¼ë©´ ë•ë‹ˆë‹¤.
            if (typeof isBananaMode !== 'undefined' && isBananaMode) {
                toggleBananaMode(); 
            }

            const res = await fetch('/api/sessions', { method: 'POST' });
            const data = await res.json();
            currentSessionId = data.id;
            chatContainer.innerHTML = '';
            await loadSessions();
            inputBox.focus();
        }
        // â–²â–²â–² [êµì²´] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²

        // â–¼â–¼â–¼ [êµì²´] ê°œë³„ ì‚­ì œ í•¨ìˆ˜ (ì»¤ìŠ¤í…€ íŒì—… ì ìš©) â–¼â–¼â–¼
        async function deleteSession(id) {
            showConfirm(
                "ì´ ì±„íŒ…ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 
                async () => {
                    await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
                    if(currentSessionId == id) { 
                        currentSessionId = null; 
                        document.getElementById('chat-container').innerHTML = ''; 
                    }
                    loadSessions();
                    showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                },
                "ğŸ—‘ï¸",
                "btn-danger"
            );
        }
        // â–²â–²â–² [êµì²´] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²

        async function loadMessages(sid) {
            currentSessionId = sid;
            const res = await fetch(`/api/sessions/${sid}/messages`);
            const msgs = await res.json();
            chatContainer.innerHTML = '';
            msgs.forEach(m => appendMessage(m.role, m.content, false));
            document.querySelectorAll('.session-item').forEach(e => e.classList.remove('active'));
            const active = document.querySelector(`.session-item[data-id="${sid}"]`);
            if(active) active.classList.add('active');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

                // =========================================
        // ğŸ“„ Word Report Generator (Samsung Style)
        // =========================================
        function exportToWord(contentDiv, title = "Report") {
            const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, BorderStyle } = docx;

            const children = [];
            const elements = contentDiv.children;

            // 1. ë¬¸ì„œ ì œëª© ì¶”ê°€
            children.push(new Paragraph({
                children: [new TextRun({ text: title, bold: true, size: 32 })], // 16pt
                spacing: { after: 400 }
            }));

            // 2. ë³¸ë¬¸ íŒŒì‹± (HTML -> Docx Object ë³€í™˜)
            for (let el of elements) {
                const text = el.innerText.trim();
                
                // A. í…Œì´ë¸” ì²˜ë¦¬
                if (el.tagName === 'TABLE' || el.querySelector('table')) {
                    const tableEl = el.tagName === 'TABLE' ? el : el.querySelector('table');
                    const rows = [];
                    
                    tableEl.querySelectorAll('tr').forEach((tr, rIndex) => {
                        const cells = [];
                        tr.querySelectorAll('td, th').forEach(td => {
                            const isHeader = (rIndex === 0);
                            cells.push(new TableCell({
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: td.innerText, bold: isHeader, size: 24 })], // 12pt
                                    alignment: isHeader ? "center" : "left"
                                })],
                                shading: { fill: isHeader ? "E7E6E6" : "FFFFFF" }, // í—¤ë” íšŒìƒ‰ ë°°ê²½
                                verticalAlign: "center",
                                margins: { top: 100, bottom: 100, left: 100, right: 100 },
                                width: { size: 100, type: WidthType.PERCENTAGE } // ìë™ ë„ˆë¹„
                            }));
                        });
                        rows.push(new TableRow({ children: cells }));
                    });

                    children.push(new Table({
                        rows: rows,
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        margins: { top: 200, bottom: 200 }
                    }));
                    children.push(new Paragraph({ text: "" })); // í…Œì´ë¸” ë’¤ ê³µë°±
                }
                
                // B. í…ìŠ¤íŠ¸(ë¬¸ë‹¨) ì²˜ë¦¬ - ê°œì¡°ì‹ ê¸°í˜¸ ê°ì§€
                else if (['P', 'DIV', 'LI', 'UL', 'OL'].includes(el.tagName)) {
                    // ì‚¼ì„± ìŠ¤íƒ€ì¼ ê°œì¡°ì‹ ë¡œì§ ì ìš©
                    let indentLevel = 0; // ê¸°ë³¸ (0cm)
                    let isBold = false;
                    let contentText = text;

                    if (text.startsWith('â–¡')) {
                        // ëŒ€í•­ëª©: êµµê²Œ, ë“¤ì—¬ì“°ê¸° ì—†ìŒ
                        isBold = true;
                        indentLevel = 0;
                    } else if (text.startsWith('-')) {
                        // ì¤‘í•­ëª©: ë“¤ì—¬ì“°ê¸° 0.5cm (ì•½ 280 twips)
                        indentLevel = 280; 
                    } else if (text.startsWith('Â·')) {
                        // ì†Œí•­ëª©: ë“¤ì—¬ì“°ê¸° 1.0cm (ì•½ 560 twips)
                        indentLevel = 560;
                    } else if (el.tagName === 'LI') {
                        indentLevel = 280; // ë¦¬ìŠ¤íŠ¸ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë“¤ì—¬ì“°ê¸°
                    }

                    children.push(new Paragraph({
                        children: [new TextRun({ 
                            text: contentText, 
                            bold: isBold, 
                            size: 28, // 14pt (ë³¸ë¬¸ í‘œì¤€)
                            font: "Malgun Gothic" // ë§‘ì€ ê³ ë”•
                        })],
                        indent: { left: indentLevel },
                        spacing: { before: 100, after: 100, line: 360 } // ì¤„ê°„ê²© 1.5ë°°
                    }));
                }
                
                // C. ì½”ë“œ ë¸”ë¡ ì²˜ë¦¬
                else if (el.tagName === 'PRE') {
                    const codeText = el.innerText;
                    children.push(new Paragraph({
                        children: [new TextRun({ 
                            text: codeText, 
                            font: "Consolas", 
                            size: 20, // 10pt
                            color: "444444" 
                        })],
                        shading: { fill: "F0F0F0" }, // íšŒìƒ‰ ë°•ìŠ¤
                        border: {
                            top: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                            bottom: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                            left: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                            right: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                        },
                        spacing: { before: 200, after: 200 }
                    }));
                }
            }

            // 3. ë¬¸ì„œ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
            const doc = new Document({
                sections: [{
                    properties: {},
                    children: children,
                }],
            });

            Packer.toBlob(doc).then((blob) => {
                const fileName = `Report_${new Date().toISOString().slice(0,10)}.docx`;
                saveAs(blob, fileName);
            });
        }

        // â–¼â–¼â–¼ [ì¶”ê°€] íŒŒì¼ ì²˜ë¦¬ ë° ì „ì†¡ ë¡œì§ í†µí•© â–¼â–¼â–¼
        let selectedFiles = [];

        // íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            if(files.length === 0) return;
            selectedFiles = [...selectedFiles, ...files];
            renderMiniPreview();
            event.target.value = ''; // ì´ˆê¸°í™”
            document.getElementById('input-box').focus();
        }

        // ë¯¸ë‹ˆ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
        function renderMiniPreview() {
            const container = document.getElementById('mini-preview-container');
            container.innerHTML = '';
            
            if (selectedFiles.length > 0) {
                container.style.display = 'flex';
            } else {
                container.style.display = 'none';
                return;
            }

            selectedFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'mini-preview-item';
                div.title = file.name; // ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ íŒŒì¼ëª… í‘œì‹œ

                // ì´ë¯¸ì§€ ì—¬ë¶€ í™•ì¸
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    div.appendChild(img);
                } else {
                    const span = document.createElement('span');
                    span.className = 'file-ext';
                    span.innerText = file.name.split('.').pop().slice(0,3).toUpperCase();
                    div.appendChild(span);
                }

                // ì‚­ì œ ì˜¤ë²„ë ˆì´ (í´ë¦­ ì‹œ ì‚­ì œ)
                const closeOverlay = document.createElement('div');
                closeOverlay.className = 'mini-preview-close';
                closeOverlay.innerHTML = 'Ã—';
                closeOverlay.onclick = (e) => { 
                    e.stopPropagation(); 
                    selectedFiles.splice(index, 1); 
                    renderMiniPreview(); 
                };
                div.appendChild(closeOverlay);

                container.appendChild(div);
            });
        }

        // sendMessage í•¨ìˆ˜ ì „ë©´ êµì²´ (FormData ì‚¬ìš©)
        window.sendMessage = async function() {
            const inputBox = document.getElementById('input-box');
            const msg = inputBox.value.trim();

            // í…ìŠ¤íŠ¸ë„ ì—†ê³  íŒŒì¼ë„ ì—†ìœ¼ë©´ ì¤‘ë‹¨
            if (isSending || (!msg && selectedFiles.length === 0)) return;
            
            isSending = true;
            if(!currentSessionId) await createNewSession();

            inputBox.value = ''; 
            inputBox.style.height = '48px'; 
            
            // ì‚¬ìš©ì í™”ë©´ í‘œì‹œìš© ë©”ì‹œì§€ êµ¬ì„±
            let displayMsg = msg;
            if (selectedFiles.length > 0) {
                // ì±„íŒ…ì°½ì—ëŠ” ê¹”ë”í•˜ê²Œ íŒŒì¼ëª…ë§Œ ì•„ì´ì½˜ê³¼ í•¨ê»˜ í‘œì‹œ
                const fileBadges = selectedFiles.map(f => `\`ğŸ“ ${f.name}\``).join(' ');
                displayMsg = `${fileBadges}\n\n${msg}`;
            }
            
            appendMessage('user', displayMsg, false);
            
            // ì „ì†¡ ì¤€ë¹„
            const filesToSend = [...selectedFiles];
            selectedFiles = []; // ë°°ì—´ ë¹„ìš°ê¸°
            renderMiniPreview(); // ë¯¸ë¦¬ë³´ê¸° ë„ê¸°

            // ë¡œë”©ë°”
            const loading = document.createElement('div');
            loading.className = 'message model';
            loading.innerHTML = `<div class="content">â³ Analyzing data...</div>`;
            chatContainer.appendChild(loading);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                let res;

                // ë°”ë‚˜ë‚˜ ëª¨ë“œ(ì´ë¯¸ì§€ ìƒì„±)ëŠ” ê¸°ì¡´ JSON ë°©ì‹
                if (typeof isBananaMode !== 'undefined' && isBananaMode) {
                    res = await fetch('/api/image', { 
                        method: 'POST', headers: {'Content-Type':'application/json'}, 
                        body: JSON.stringify({ sessionId: currentSessionId, prompt: msg }) 
                    });
                } else {
                    // [í•µì‹¬] ì¼ë°˜ ëŒ€í™” (íŒŒì¼ í¬í•¨ ê°€ëŠ¥) -> FormData ì „ì†¡
                    const formData = new FormData();
                    formData.append('sessionId', currentSessionId);
                    formData.append('message', msg); // í…ìŠ¤íŠ¸
                    formData.append('modelName', document.getElementById('model-select').value);
                    formData.append('modeName', document.getElementById('mode-select').value);
                    
                    // íŒŒì¼ ì¶”ê°€ (upload.array('files')ì™€ ë§¤ì¹­)
                    filesToSend.forEach(file => {
                        formData.append('files', file);
                    });

                    // fetch í˜¸ì¶œ (Content-Type í—¤ë” ìƒëµ -> ë¸Œë¼ìš°ì € ìë™ ì„¤ì •)
                    res = await fetch('/api/chat', { method: 'POST', body: formData });
                }

                const data = await res.json();
                chatContainer.removeChild(loading);
                
                if (!res.ok) throw new Error(data.error || 'Server Error');
                appendMessage('model', data.response, true);
                
                // â–¼â–¼â–¼ [ì¶”ê°€] ì²« ë²ˆì§¸ ëŒ€í™”ì˜€ë‹¤ë©´ ì‚¬ì´ë“œë°” ì œëª© ê°±ì‹ ì„ ìœ„í•´ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° â–¼â–¼â–¼
                // (í˜„ì¬ ë©”ì‹œì§€ê°€ 2ê°œ(ì§ˆë¬¸+ë‹µë³€) ì´í•˜ë¼ë©´ ì²« ëŒ€í™”ë¡œ ê°„ì£¼)
                if (chatContainer.children.length <= 2) {
                    loadSessions(); 
                }
                // â–²â–²â–² [ì¶”ê°€] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²
                
            } catch(e) {
                if(loading.parentNode) chatContainer.removeChild(loading);
                appendMessage('model', `âŒ Error: ${e.message}`, false);
            }
            isSending = false;
        };
        // â–²â–²â–² [ìˆ˜ì • ì™„ë£Œ] â–²â–²â–²

        // â–¼â–¼â–¼ [ìˆ˜ì •] appendMessage í•¨ìˆ˜ ë‚´ë¶€: ê¸´ ë©”ì‹œì§€ í† ê¸€ ë° êµ¬ì¡° ê°œì„  â–¼â–¼â–¼
        function appendMessage(role, content, animate) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            
            // â˜… í•µì‹¬: í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ë³„ë„ divë¡œ ê°ì‹¸ì„œ íŒ¨ë”© ë¬¸ì œ í•´ê²°
            const textWrapper = document.createElement('div');
            textWrapper.className = 'markdown-body'; // CSS ì ìš© ëŒ€ìƒ
            
            const MAX_LENGTH = 1000; // 1000ì ì´ìƒì¼ ë•Œ ì ‘ê¸°
            
            if (role === 'user' && content.length > MAX_LENGTH) {
                // 1. ì ‘íŒ ìƒíƒœë¡œ ì‹œì‘
                contentDiv.classList.add('collapsed'); 
                // ğŸ”¥ [ì¶”ê°€] ë²„íŠ¼ì´ ë‹¬ë¦¬ë¯€ë¡œ í•˜ë‹¨ íŒ¨ë”©ì„ ì—†ì• ëŠ” í´ë˜ìŠ¤ ì¶”ê°€
                contentDiv.classList.add('has-footer');
                
                // í…ìŠ¤íŠ¸ ë Œë”ë§ (ì¤„ë°”ê¿ˆ ì²˜ë¦¬ í¬í•¨)
                // (ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ë³´í†µ ë§ˆí¬ë‹¤ìš´ë³´ë‹¤ëŠ” í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ëŠ” ê²Œ ì•ˆì „í•  ìˆ˜ ìˆìŒ)
                textWrapper.innerText = content; 
                contentDiv.appendChild(textWrapper);
                
                // 2. í† ê¸€ ë²„íŠ¼ ìƒì„±
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'read-more-btn';
                toggleBtn.innerHTML = `ğŸ”½ ì „ì²´ ë³´ê¸° (${content.length.toLocaleString()}ì)`;
                
                // ... (ë²„íŠ¼ ìƒì„± ë¶€ë¶„)
                toggleBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    const isCollapsed = contentDiv.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        // [í¼ì¹˜ê¸°]
                        contentDiv.classList.remove('collapsed');
                        toggleBtn.innerHTML = `ğŸ”¼ ì ‘ê¸°`;
                        
                        // íë¦¼ íš¨ê³¼ ì œê±°
                        textWrapper.style.maskImage = 'none';
                        textWrapper.style.webkitMaskImage = 'none';
                        
                        // â˜… í¼ì³¤ì„ ë•ŒëŠ” ë‚´ìš©ì„ ì½ì–´ì•¼ í•˜ë¯€ë¡œ 'ì‹œì‘ ë¶€ë¶„'ì´ ë³´ì´ê²Œ í•¨ (ì‚¬ìš©ì„± ê³ ë ¤)
                        // (ë§Œì•½ ë¬´ì¡°ê±´ ëìœ¼ë¡œ ê°€ê³  ì‹¶ë‹¤ë©´ 'end'ë¡œ ë³€ê²½ ê°€ëŠ¥í•˜ì§€ë§Œ, ì½ê¸° ë¶ˆí¸í•  ìˆ˜ ìˆìŒ)
                        // div.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        // [ì ‘ê¸°]
                        contentDiv.classList.add('collapsed');
                        toggleBtn.innerHTML = `ğŸ”½ ì „ì²´ ë³´ê¸° (${content.length.toLocaleString()}ì)`;
                        
                        textWrapper.style.maskImage = '';
                        textWrapper.style.webkitMaskImage = '';
                        
                        // ì ‘ì—ˆì„ ë•ŒëŠ” ë²„íŠ¼ì´ ì˜ ë³´ì´ë„ë¡ ìœ„ì¹˜ ì¡°ì •
                        toggleBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                };
                
                contentDiv.appendChild(toggleBtn);
            } else {
                // ì§§ì€ ë©”ì‹œì§€ëŠ” ê·¸ëƒ¥ í‘œì‹œ
                if (role === 'user') {
                    textWrapper.innerText = content;
                } else {
                    // ëª¨ë¸ ë©”ì‹œì§€ëŠ” ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ì„ ìœ„í•´ ë‚˜ì¤‘ì— ì²˜ë¦¬
                    // (ì•„ë˜ renderMarkdownì—ì„œ ì²˜ë¦¬ë¨)
                }
                contentDiv.appendChild(textWrapper);
            }
            
            div.appendChild(contentDiv);
            chatContainer.appendChild(div);
            
            const renderMarkdown = () => {
                contentDiv.innerHTML = marked.parse(content);
                contentDiv.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
                
                const copyIcon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;

                // appendMessage í•¨ìˆ˜ ë‚´ë¶€ (renderMarkdown ì•ˆìª½, role === 'model' ì²´í¬í•˜ëŠ” ë¶€ë¶„)

                if (role === 'model') {
                    // 1. ê¸°ì¡´ Copy ë²„íŠ¼ (ìœ ì§€)
                    const msgCopyBtn = document.createElement('button');
                    msgCopyBtn.className = 'msg-copy-btn';
                    msgCopyBtn.title = 'Copy Message';
                    msgCopyBtn.innerHTML = copyIcon; // ê¸°ì¡´ ì•„ì´ì½˜
                    msgCopyBtn.onclick = () => safeCopy(content, msgCopyBtn);
                    contentDiv.appendChild(msgCopyBtn);

                    textWrapper.innerHTML = marked.parse(content);
                    textWrapper.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));

                    // 2. [ì¶”ê°€] Word ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
                    const wordBtn = document.createElement('button');
                    wordBtn.className = 'msg-copy-btn'; // ìŠ¤íƒ€ì¼ ê³µìœ  (ìœ„ì¹˜ë§Œ ì¡°ì • í•„ìš”)
                    wordBtn.style.right = '40px'; // Copy ë²„íŠ¼ ì™¼ìª½ìœ¼ë¡œ ë°°ì¹˜
                    wordBtn.title = 'Export to Word';
                    // Word ì•„ì´ì½˜ (W)
                    wordBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="8" y="18" font-size="8" font-weight="bold" fill="currentColor">W</text></svg>`;
                    
                    wordBtn.onclick = () => {
                        // ë²„íŠ¼ ë¡œë”© íš¨ê³¼
                        const originalHtml = wordBtn.innerHTML;
                        wordBtn.innerHTML = `<span style="font-size:10px">...</span>`;
                        
                        // ì›Œë“œ ë³€í™˜ ì‹¤í–‰ (contentDiv ì „ì²´ë¥¼ ë„˜ê¹€)
                        exportToWord(contentDiv, "Project Report");
                        
                        setTimeout(() => wordBtn.innerHTML = originalHtml, 1000);
                    };
                    contentDiv.appendChild(wordBtn);
                }
                

                contentDiv.querySelectorAll('pre').forEach(pre => {
                    const btn = document.createElement('button');
                    btn.className = 'code-copy-btn';
                    btn.title = 'Copy Code';
                    btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
                    const code = pre.querySelector('code');
                    if(code) {
                        btn.onclick = () => safeCopy(code.innerText, btn);
                        pre.appendChild(btn);
                    }
                });
            };
            if (role === 'model') renderMarkdown(); // ëª¨ë¸ì¼ ë•Œë§Œ ì‹¤í–‰
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        inputBox.addEventListener('compositionstart', () => { isComposing = true; });
        inputBox.addEventListener('compositionend', () => { isComposing = false; });

        
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('new-chat-btn').onclick = handleNewChat;
        document.getElementById('input-box').addEventListener('input', function() {
            // 1. ë†’ì´ ê³„ì‚°ì„ ìœ„í•´ ì ì‹œ autoë¡œ ì´ˆê¸°í™”
            this.style.height = 'auto';
            
            // 2. ìµœëŒ€ ë†’ì´ ì„¤ì • (150px)
            const maxHeight = 150;
            
            // 3. ë‚´ìš©ì´ 150pxì„ ë„˜ìœ¼ë©´ ë†’ì´ë¥¼ ê³ ì •í•˜ê³  ìŠ¤í¬ë¡¤ì„ ì¼¬ (auto)
            if (this.scrollHeight > maxHeight) {
                this.style.height = maxHeight + 'px';
                this.style.overflowY = 'auto';
            } else {
                // ë‚´ìš©ì´ 150px ì´í•˜ë¼ë©´ ë†’ì´ë¥¼ ëŠ˜ë¦¬ê³  ìŠ¤í¬ë¡¤ì„ ìˆ¨ê¹€ (hidden)
                this.style.height = this.scrollHeight + 'px';
                this.style.overflowY = 'hidden';
            }
            
            if(this.value === '') {
                this.style.height = 'auto';
                this.style.overflowY = 'hidden';
            }
        });

        // â–¼â–¼â–¼ [êµì²´] ì–´ë“œë¯¼ íŒ¨ë„ (ê´€ë¦¬ì ê¶Œí•œ ê³ ì • ë¡œì§ ì¶”ê°€) â–¼â–¼â–¼
        async function openAdminPanel() {
            const modal = document.getElementById('admin-modal');
            modal.style.display = 'flex'; 
            loadKnowledgeList();

            // 1. ì„œë²„ ìƒíƒœ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
            // â–¼â–¼â–¼ [ìˆ˜ì •] openAdminPanel í•¨ìˆ˜ ë‚´ë¶€ì˜ 'ì„œë²„ ìƒíƒœ í‘œì‹œ' ë¶€ë¶„ â–¼â–¼â–¼
            try {
                const s = await fetch('/api/admin/status').then(r => r.json());
                
                // 1. Memory (ê¸°ì¡´ ìœ ì§€)
                const memPct = Math.round((s.memory.used / s.memory.total) * 100);
                document.getElementById('status-mem').innerText = `${(s.memory.used/1024/1024/1024).toFixed(1)}GB`;
                document.getElementById('status-mem-sub').innerText = `${memPct}% Used`;

                // 2. CPU (Load -> % ë¡œ ë³€ê²½) ğŸ”¥
                // í° ê¸€ì”¨: 42%
                // ì‘ì€ ê¸€ì”¨: 0.42 (4 Cores)
                document.getElementById('status-load').innerText = `${s.cpuPct}%`;
                document.getElementById('status-load-pct').innerText = `${s.load.toFixed(2)} (${s.cpuCount}C)`;

                // 3. Storage (%ì™€ DBìš©ëŸ‰ í•¨ê»˜ í‘œì‹œ) ğŸ”¥
                // í° ê¸€ì”¨: 24% (ë””ìŠ¤í¬ ì „ì²´ ì‚¬ìš©ë¥ )
                // ì‘ì€ ê¸€ì”¨: DB: 0.77 MB
                document.getElementById('status-disk').innerText = s.disk.pct; 
                document.getElementById('status-disk-sub').innerText = `DB: ${s.dbSize} (${s.disk.used} / ${s.disk.total})`;
                
                // 4. Uptime
                const upH = Math.floor(s.uptime / 3600);
                document.getElementById('status-uptime').innerText = `System Uptime: ${upH}h`;
            } catch(e) { console.error(e); }
        // â–²â–²â–² [ìˆ˜ì •] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²

            // 2. ìœ ì € ë¦¬ìŠ¤íŠ¸ (ê´€ë¦¬ì ê¶Œí•œ ê³ ì • ë¡œì§ ì ìš©)
            const res = await fetch('/api/admin/users');
            const users = await res.json();
            const tbody = document.getElementById('admin-user-list');
            tbody.innerHTML = '';
            
            users.forEach(u => {
                const tr = document.createElement('tr');
                const isAdmin = (u.username === 'shoo.kim' || u.role === 'admin');

                // (1) Pro ë°°ì§€
                const proBadge = (u.allow_pro || isAdmin)
                    ? `<span style="color:#339af0; font-weight:800;">PRO</span>` 
                    : `<span style="color:#868e96; font-size:0.9rem;">LITE</span>`;
                    
                // (2) ë°”ë‚˜ë‚˜ ë°°ì§€ (ê´€ë¦¬ìëŠ” ë¬´ì¡°ê±´ ON í‘œì‹œ)
                const bananaBadge = (u.allow_image || isAdmin)
                    ? `<span style="font-size:1.2rem; margin-left:8px;" title="Image Gen ON">ğŸŒ</span>`
                    : `<span style="font-size:1.2rem; margin-left:8px; opacity:0.1; filter:grayscale(100%);" title="Image Gen OFF">ğŸŒ</span>`;

                // (3) ë°”ë‚˜ë‚˜ ë²„íŠ¼ ë¡œì§ (ê´€ë¦¬ìëŠ” ë²„íŠ¼ ë¹„í™œì„±í™”)
                let bananaBtn;
                if (isAdmin) {
                    // ê´€ë¦¬ììš© ë²„íŠ¼ (í´ë¦­ ë¶ˆê°€, í•­ìƒ ë…¸ë€ìƒ‰)
                    bananaBtn = `<button class="action-btn" style="background:#fab005; color:#000; font-weight:bold; cursor:default; opacity:0.7;" title="Admin Always ON">ğŸ”’</button>`;
                } else {
                    // ì¼ë°˜ ìœ ì €ìš© ë²„íŠ¼ (í† ê¸€ ê°€ëŠ¥)
                    // ì—¬ê¸°ì„œ allow_imageê°€ undefinedì¼ ê²½ìš° 0ìœ¼ë¡œ ì²˜ë¦¬
                    const currentVal = u.allow_image ? 1 : 0;
                    const nextVal = currentVal === 1 ? 0 : 1; 
                    const btnColor = currentVal === 1 ? '#fab005' : 'rgba(255,255,255,0.1)';
                    const txtColor = currentVal === 1 ? '#000' : '#888';
                    
                    bananaBtn = `<button class="action-btn" onclick="updateUser(${u.id},${u.is_approved},${u.allow_pro},${nextVal})" style="background:${btnColor}; color:${txtColor}; font-weight:bold;">ğŸŒ</button>`;
                }

                tr.innerHTML = `
                    <td style="font-weight:bold; color:white;">
                        ${u.username} ${isAdmin ? 'ğŸ‘‘' : ''}
                    </td>
                    <td><span style="color:${u.is_approved?'var(--success)':'var(--error)'}">${u.is_approved?'Active':'Wait'}</span></td>
                    
                    <td style="display:flex; align-items:center;">
                        ${proBadge} 
                        <span style="color:rgba(255,255,255,0.1); margin:0 8px;">|</span> 
                        ${bananaBadge}
                    </td>
                    
                    <td>
                        <button class="action-btn" onclick="updateUser(${u.id},1,${u.allow_pro},${u.allow_image})" style="background:#51cf66; color:#fff;">OK</button>
                        
                        <button class="action-btn" onclick="updateUser(${u.id},${u.is_approved},${u.allow_pro?0:1},${u.allow_image})" style="background:${u.allow_pro?'#1c7ed6':'#339af0'}; color:#fff;">Pro</button>
                        
                        ${bananaBtn}
                        
                        <button class="action-btn delete-user-btn" onclick="deleteUser(${u.id})">Del</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }
        // â–²â–²â–² [êµì²´] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²
        
        async function shutdownServer() { if(!confirm('Shutdown?')) return; try { await fetch('/api/admin/shutdown', { method: 'POST' }); alert('Bye'); window.close(); } catch(e) {} }

        async function ingestKnowledge() {
            const t = document.getElementById('ingest-title').value;
            const c = document.getElementById('ingest-content').value;
            if(!t || !c) return alert('Please enter both title and content.');
            
            try {
                const res = await fetch('/api/admin/ingest', { 
                    method: 'POST', headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify({ title:t, content:c }) 
                });
                if(res.ok) { 
                    alert('Saved successfully.'); 
                    document.getElementById('ingest-title').value = ''; 
                    document.getElementById('ingest-content').value = ''; 
                    await loadKnowledgeList(); 
                } else { alert('Save failed.'); }
            } catch(e) { console.error(e); alert('Error occurred.'); }
        }

        async function loadKnowledgeList() {
            const tbody = document.getElementById('admin-knowledge-list');
            try {
                const res = await fetch('/api/admin/knowledge');
                if (!res.ok) throw new Error("Failed to fetch");
                const list = await res.json();
                tbody.innerHTML = ''; 
                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:15px; color:#777;">No stored knowledge found.</td></tr>';
                    return;
                }
                list.forEach(item => {
                    const tr = document.createElement('tr');
                    const dateStr = new Date(item.created_at).toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    tr.innerHTML = `<td>${item.id}</td><td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.title}">${item.title}</td><td>${dateStr}</td><td><button class="action-btn delete-user-btn" onclick="deleteMessage(${item.id})">Del</button></td>`;
                    tbody.appendChild(tr);
                });
            } catch (e) { tbody.innerHTML = '<tr><td colspan="4" style="color:#fa5252; text-align:center;">Failed to load list.</td></tr>'; }
        }

        async function deleteMessage(id) { 
            if(!confirm('Permanently delete this knowledge?')) return; 
            try {
                const res = await fetch(`/api/admin/messages/${id}`, { method: 'DELETE' });
                if(res.ok) loadKnowledgeList(); 
                else alert('Delete failed');
            } catch(e) { console.error(e); }
        }

        // â–¼â–¼â–¼ [ìˆ˜ì •ë¨] updateUser í•¨ìˆ˜ (ë°”ë‚˜ë‚˜ ê°’ 'i'ê°€ ì¶”ê°€ë¨) â–¼â–¼â–¼
        async function updateUser(id, a, p, i) { 
            // i (allow_image)ê°€ undefinedì¼ ê²½ìš° 0ìœ¼ë¡œ ì²˜ë¦¬ (ì•ˆì „ì¥ì¹˜)
            if (i === undefined || i === null) i = 0;

            await fetch('/api/admin/update', {
                method: 'POST', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({
                    id: id, 
                    is_approved: a, 
                    allow_pro: p, 
                    allow_image: i  // ğŸ”¥ ì—¬ê¸°ê°€ ë¹ ì ¸ ìˆì–´ì„œ DB ì €ì¥ì´ ì•ˆ ëë˜ ê²ë‹ˆë‹¤!
                })
            }); 
            
            openAdminPanel(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        }
        // â–²â–²â–² [ìˆ˜ì •ë¨] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²
        async function deleteUser(id) { if(confirm('Delete User?')) { await fetch(`/api/admin/users/${id}`, {method:'DELETE'}); openAdminPanel(); } }

        (async function() {
            const res = await fetch('/api/auth/me');
            if(res.ok) { currentUser = await res.json(); initApp(); }
        })();

        // Snow & Copy Fix
        function createSnowflakes() {
            const container = document.getElementById('snow-header-snow');
            if (!container) return; 
            const count = 40; 
            for (let i = 0; i < count; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                const size = Math.random() * 3 + 2 + 'px'; 
                flake.style.width = size; flake.style.height = size;
                flake.style.left = Math.random() * 100 + '%';
                flake.style.animationDuration = Math.random() * 3 + 2 + 's'; 
                flake.style.animationDelay = Math.random() * -5 + 's';
                flake.style.opacity = Math.random() * 0.4 + 0.3;
                container.appendChild(flake);
            }
        }
        createSnowflakes();

        // â–¼â–¼â–¼ [ìˆ˜ì •ë¨] ë³µì‚¬ ë¡œì§ ê°œì„ : ì½”ë“œ ë¸”ë¡ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ â–¼â–¼â–¼
        document.addEventListener('copy', function(e) {
            const selection = window.getSelection();
            
            // 1. ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ì—†ê±°ë‚˜, ì±„íŒ… ì˜ì—­ ë°–ì´ë©´ íŒ¨ìŠ¤
            if (selection.rangeCount === 0) return;
            const container = document.getElementById('chat-container');
            if (!container.contains(selection.anchorNode)) return;

            // ğŸ”¥ [ì¶”ê°€ëœ ì˜ˆì™¸ ì²˜ë¦¬] 
            // ë§Œì•½ ì„ íƒëœ ì˜ì—­ì´ 'ì½”ë“œ ë¸”ë¡(PRE, CODE)' ë‚´ë¶€ë¼ë©´? 
            // -> ì´ë©”ì¼ìš© ì„œì‹ ë³€í™˜ì„ í•˜ì§€ ë§ê³ , ê·¸ëƒ¥ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬ë˜ê²Œ ë†”ë‘”ë‹¤.
            let parent = selection.anchorNode.parentElement;
            while(parent) {
                if (parent.tagName === 'PRE' || parent.tagName === 'CODE') {
                    return; // í•¨ìˆ˜ ì¢…ë£Œ -> ë¸Œë¼ìš°ì € ê¸°ë³¸ ë³µì‚¬(Ctrl+C) ì‹¤í–‰ë¨
                }
                parent = parent.parentElement;
            }

            // 2. ì—¬ê¸°ì„œë¶€í„°ëŠ” 'ì¼ë°˜ í…ìŠ¤íŠ¸'ì´ë¯€ë¡œ ë‹¤í¬ëª¨ë“œ í•´ì œ(ë³´ê³ ì„œìš©) ë¡œì§ ì‹¤í–‰
            e.preventDefault();

            // ì„ íƒëœ ì˜ì—­ì˜ HTMLì„ ê°€ì ¸ì˜´
            const range = selection.getRangeAt(0);
            const clonedContent = range.cloneContents();
            const tempDiv = document.createElement('div');
            tempDiv.appendChild(clonedContent);

            // ìŠ¤íƒ€ì¼ ê°•ì œ ë³€í™˜ (Dark -> Light)
            tempDiv.style.color = '#000000';           
            tempDiv.style.backgroundColor = 'transparent'; 
            tempDiv.style.fontFamily = "'Pretendard', sans-serif"; 

            const allElements = tempDiv.querySelectorAll('*');
            allElements.forEach(el => {
                el.style.color = '#000000';
                el.style.backgroundColor = 'transparent';
                if (el.tagName === 'A') {
                    el.style.color = '#0000FF';
                    el.style.textDecoration = 'underline';
                }
            });

            // í‘œ ìŠ¤íƒ€ì¼ ì •ë¦¬
            const tables = tempDiv.querySelectorAll('table');
            tables.forEach(table => {
                table.style.borderCollapse = 'collapse';
                table.style.width = '100%';
                table.style.marginBottom = '10px';
                table.style.border = '1px solid #000'; 
            });

            const cells = tempDiv.querySelectorAll('th, td');
            cells.forEach(cell => {
                cell.style.border = '1px solid #888'; 
                cell.style.padding = '8px'; 
                cell.style.color = '#000';
                if (cell.tagName === 'TH') {
                    cell.style.backgroundColor = '#f2f2f2'; 
                    cell.style.fontWeight = 'bold';
                    cell.style.borderBottom = '2px solid #000';
                }
            });

            // í´ë¦½ë³´ë“œì— ì“°ê¸°
            if (e.clipboardData) {
                e.clipboardData.setData('text/html', tempDiv.innerHTML); 
                e.clipboardData.setData('text/plain', selection.toString()); 
            }
        });

            const slashCommands = [
                /*
                { cmd: '/sql', desc: 'ì¿¼ë¦¬ ìµœì í™” ë¶„ì„', text: 'ë‹¤ìŒ SQL ì¿¼ë¦¬ì˜ ì‹¤í–‰ ê³„íšì„ ë¶„ì„í•˜ê³  ì„±ëŠ¥ ìµœì í™” ë°©ì•ˆì„ ì œì‹œí•´ì¤˜:\n```sql\n\n```' },
                { cmd: '/log', desc: 'ì—ëŸ¬ ë¡œê·¸ ì›ì¸ íŒŒì•…', text: 'ë‹¤ìŒ ì—ëŸ¬ ë¡œê·¸ì˜ ê·¼ë³¸ ì›ì¸ì„ ë¶„ì„í•˜ê³  í•´ê²°ì±…ì„ ì•Œë ¤ì¤˜:\n' },
                { cmd: '/doc', desc: 'ì½”ë“œ ë¬¸ì„œí™”(Docstring)', text: 'ë‹¤ìŒ ì½”ë“œì— ëŒ€í•´ Sphinx ìŠ¤íƒ€ì¼ì˜ Docstringì„ ì‘ì„±í•˜ê³  ê¸°ëŠ¥ì„ ìš”ì•½í•´ì¤˜:\n' },
                { cmd: '/fix', desc: 'ë²„ê·¸ ìˆ˜ì •', text: 'ì´ ì½”ë“œì—ì„œ ì ì¬ì ì¸ ë²„ê·¸ë¥¼ ì°¾ì•„ì„œ ìˆ˜ì •í•´ì¤˜:\n' },
                // â–¼â–¼â–¼ [ì¶”ê°€] ë³´ê³ ì„œ ìƒì„± ëª…ë ¹ì–´ â–¼â–¼â–¼
                { cmd: '/report', desc: 'ë³´ê³ ì„œ ì´ˆì•ˆ ì‘ì„± (Word)', text: 'ì•„ë˜ ë‚´ìš©ì„ ì‚¼ì„±ì›°ìŠ¤í† ë¦¬ í‘œì¤€ ë³´ê³ ì„œ ì–‘ì‹(â–¡ í•µì‹¬ë‚´ìš©, - ìƒì„¸ì„¤ëª…, Â· ê·¼ê±°)ì— ë§ì¶° ì‘ì„±í•´ì£¼ê³ , ìˆ˜ì¹˜ ë°ì´í„°ëŠ” í‘œë¡œ ì •ë¦¬í•´ì¤˜:\n' }, */
                //ì—­í•  ë¶€ì—¬
                // â–¼â–¼â–¼ [ì¶”ê°€] Custom Mode ì „ìš© í˜ë¥´ì†Œë‚˜ ëª…ë ¹ì–´ â–¼â–¼â–¼
                { cmd: '/Food Research Scientist', desc: 'ì‹í’ˆì—°êµ¬ì†Œ ë‹´ë‹¹ì', text: 'ë‹¹ì‹ ì€ ì‹í’ˆ ê°œë°œê³¼ ì•ˆì „ ê¸°ì¤€ì„ ê³¼í•™ì ìœ¼ë¡œ ê²€ì¦í•˜ë©°, ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¯¸ë˜ ì‹ë¬¸í™”ë¥¼ ì„¤ê³„í•˜ëŠ” ì—°êµ¬ ì „ë¬¸ê°€.' },
                { cmd: '/Knox Operations Lead', desc: 'Knox ë‹´ë‹¹ì', text: 'ë‹¹ì‹ ì€ ì¡°ì§ì˜ ì—…ë¬´íë¦„ì„ ìë™í™”Â·í‘œì¤€í™”í•˜ê¸° ìœ„í•´ Knox í”Œë«í¼ì„ ì•ˆì •ì ìœ¼ë¡œ ìš´ì˜í•˜ê³  ìµœì ì˜ ì‚¬ìš©ì ê²½í—˜ì„ ì„¤ê³„í•˜ëŠ” ë””ì§€í„¸ ì—…ë¬´ ì „ë¬¸ê°€.' },
                { cmd: '/Master Data Steward', desc: 'ê¸°ì¤€ì •ë³´ ë‹´ë‹¹ì', text: 'ë‹¹ì‹ ì€ ì „ì‚¬ ë°ì´í„°ë¥¼ ì¼ê´€ë˜ê³  ì‹ ë¢°ì„± ìˆê²Œ ìœ ì§€í•˜ê¸° ìœ„í•´ í‘œì¤€ ì •ì˜Â·ê´€ë¦¬Â·í†µì œë¥¼ ì£¼ë„í•˜ëŠ” ë°ì´í„° ê±°ë²„ë„ŒìŠ¤ í•µì‹¬ ë‹´ë‹¹ì.' },
                { cmd: '/Network Engineer', desc: 'ë„¤íŠ¸ì›Œí¬ ë‹´ë‹¹ì', text: 'ë‹¹ì‹ ì€ ê¸°ì—… ì¸í”„ë¼ì˜ ëŠê¹€ ì—†ëŠ” ì—°ê²°ì„±ê³¼ ë³´ì•ˆì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ë„¤íŠ¸ì›Œí¬ ì„¤ê³„Â·ìš´ì˜Â·ì¥ì•  ëŒ€ì‘ì„ ì±…ì„ì§€ëŠ” ì¸í”„ë¼ ì•ˆì •ì„± ì „ë¬¸ê°€.' }
            ];

            // â–¼â–¼â–¼ [ìˆ˜ì •] í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¡œì§ í†µí•© (ì „ì†¡ vs ë©”ë‰´ì„ íƒ ì¶©ëŒ í•´ê²°) â–¼â–¼â–¼
            const slashMenu = document.getElementById('slash-menu');
            let slashIdx = 0;

            // 1. Keydown: í‚¤ë¥¼ 'ëˆ„ë¥´ëŠ” ìˆœê°„' ë™ì‘ (ë„¤ë¹„ê²Œì´ì…˜ ë° ì „ì†¡ ì œì–´)
            inputBox.addEventListener('keydown', (e) => {
                // (A) ìŠ¬ë˜ì‹œ ë©”ë‰´ê°€ ì—´ë ¤ìˆì„ ë•Œì˜ ë™ì‘
                if (slashMenu.style.display === 'flex') {
                    const items = document.querySelectorAll('.slash-item');
                    
                    if (e.key === 'ArrowUp') {
                        e.preventDefault(); // ì»¤ì„œ ì´ë™ ë°©ì§€
                        slashIdx = Math.max(0, slashIdx - 1);
                        updateSlashSelect();
                        return;
                    }
                    if (e.key === 'ArrowDown') {
                        e.preventDefault(); // ì»¤ì„œ ì´ë™ ë°©ì§€
                        slashIdx = Math.min(items.length - 1, slashIdx + 1);
                        updateSlashSelect();
                        return;
                    }
                    if (e.key === 'Enter') {
                        e.preventDefault(); // â˜… í•µì‹¬: ì¤„ë°”ê¿ˆ ë° ì „ì†¡ ë§‰ê¸°
                        e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
                        applySlash(slashCommands[slashIdx].text); // ì„ íƒ ì ìš©
                        return;
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        slashMenu.style.display = 'none';
                        return;
                    }
                }

                // (B) ì¼ë°˜ì ì¸ ë©”ì‹œì§€ ì „ì†¡ ë™ì‘ (ë©”ë‰´ê°€ ë‹«í˜€ìˆì„ ë•Œë§Œ)
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (isComposing) return; // í•œê¸€ ì¡°í•© ì¤‘ì´ë©´ ì „ì†¡ ì•ˆ í•¨
                    sendMessage();
                }
            });

            // 2. Keyup: í‚¤ë¥¼ 'ë—ì„ ë•Œ' ë™ì‘ (í…ìŠ¤íŠ¸ ê°ì§€ ë° ë©”ë‰´ ì—´ê¸°)
            inputBox.addEventListener('keyup', (e) => {
                // ë„¤ë¹„ê²Œì´ì…˜ í‚¤ëŠ” keydownì—ì„œ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ë¬´ì‹œ
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'Enter' || e.key === 'Escape') return;

                const val = inputBox.value;

                // '/' ì…ë ¥ ê°ì§€ -> ë©”ë‰´ ì—´ê¸°
                if (val === '/') {
                    slashMenu.innerHTML = slashCommands.map((c, i) => 
                        `<div class="slash-item ${i===0?'selected':''}" onclick="applySlash(slashCommands[${i}].text)">
                            <span class="slash-cmd">${c.cmd}</span><span class="slash-desc">${c.desc}</span>
                        </div>`
                    ).join('');
                    slashMenu.style.display = 'flex';
                    slashIdx = 0;
                } else if (val === '') {
                    // ë‚´ìš©ì„ ë‹¤ ì§€ìš°ë©´ ë©”ë‰´ ë‹«ê¸°
                    slashMenu.style.display = 'none';
                }
                // ('/' ë’¤ì— ê¸€ìë¥¼ ë” ì¹˜ë©´ ë©”ë‰´ ë‹«ì„ì§€ ì—¬ë¶€ëŠ” ì·¨í–¥ì— ë”°ë¼ ê²°ì •. í˜„ì¬ëŠ” '/' ë”± í•œ ê¸€ìì¼ ë•Œë§Œ ì—´ë¦¼)
                else if (val.length > 1 && slashMenu.style.display === 'flex') {
                     slashMenu.style.display = 'none';
                }
            });
            // â–²â–²â–² [ìˆ˜ì • ì™„ë£Œ] â–²â–²â–²

            function updateSlashSelect() {
                document.querySelectorAll('.slash-item').forEach((el, i) => {
                    el.className = `slash-item ${i === slashIdx ? 'selected' : ''}`;
                });
            }

            function applySlash(text) {
                inputBox.value = text;
                slashMenu.style.display = 'none';
                inputBox.focus();
            }

            // ... (slashCommands ë°°ì—´ ì •ì˜ ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€í•˜ì„¸ìš”) ...

            // â–¼â–¼â–¼ [ì¶”ê°€] ëª¨ë“œ ë³€ê²½ ì‹œ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ ì´ë²¤íŠ¸ â–¼â–¼â–¼
            document.getElementById('mode-select').addEventListener('change', function(e) {
                const mode = e.target.value;
                const inputBox = document.getElementById('input-box');
                
                if (mode === 'custom') {
                    // 1. ì…ë ¥ì°½ ì•ˆë‚´ ë¬¸êµ¬ ë³€ê²½
                    inputBox.placeholder = "ğŸ­ í˜ë¥´ì†Œë‚˜ ì •ì˜: ì²« ë©”ì‹œì§€ë¡œ ì—­í• ì„ ë¶€ì—¬í•˜ì„¸ìš” (ì˜ˆ: / ì…ë ¥)";
                    inputBox.focus();
                    
                    // 2. í† ìŠ¤íŠ¸ ì•Œë¦¼ ë„ìš°ê¸° (ì‚¬ìš©ìì—ê²Œ ëª…í™•íˆ ì¸ì§€ì‹œí‚´)
                    showToast("Custom ëª¨ë“œ: ì²« ë©”ì‹œì§€ê°€ ì´ ì±„íŒ…ë°©ì˜ ì˜êµ¬ì ì¸ ì—­í• ì´ ë©ë‹ˆë‹¤.", "ğŸ­");
                    
                    // 3. (ì„ íƒì‚¬í•­) í¸ì˜ë¥¼ ìœ„í•´ ìë™ìœ¼ë¡œ ìŠ¬ë˜ì‹œ ë©”ë‰´ë¥¼ ë„ì›Œì¤„ ìˆ˜ë„ ìˆìŒ
                    // inputBox.value = '/'; 
                    // inputBox.dispatchEvent(new Event('keyup')); // ìŠ¬ë˜ì‹œ ë©”ë‰´ ê°•ì œ íŠ¸ë¦¬ê±°
                } else {
                    // ë‹¤ë¥¸ ëª¨ë“œë¡œ ëŒì•„ì˜¤ë©´ ë¬¸êµ¬ ì›ìƒë³µêµ¬ (ë°”ë‚˜ë‚˜ ëª¨ë“œ ì²´í¬)
                    if (typeof isBananaMode !== 'undefined' && isBananaMode) {
                        inputBox.placeholder = "ğŸŒ [Banana Mode] ìƒìƒí•˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë¬˜ì‚¬í•´ë³´ì„¸ìš”...";
                    } else {
                        inputBox.placeholder = "Ask anything...";
                    }
                }
            });
            // â–²â–²â–² [ì¶”ê°€] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²

            // â–¼â–¼â–¼ [ë³µë¶™] ë°”ë‚˜ë‚˜ ëª¨ë“œ ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ (script íƒœê·¸ ë§¨ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°) â–¼â–¼â–¼

            let isBananaMode = false;

            // 1. ë°”ë‚˜ë‚˜ ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
            function toggleBananaMode() {
                isBananaMode = !isBananaMode;
                const btn = document.getElementById('banana-btn');
                const body = document.body;
                const inputBox = document.getElementById('input-box');
                
                if (isBananaMode) {
                    btn.classList.add('active');
                    body.classList.add('banana-mode');
                    inputBox.placeholder = "ğŸŒ [Banana Mode] ìƒìƒí•˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë¬˜ì‚¬í•´ë³´ì„¸ìš”...";
                } else {
                    btn.classList.remove('active');
                    body.classList.remove('banana-mode');
                    inputBox.placeholder = "Ask anything...";
                }
            }

            // â–¼â–¼â–¼ [ìˆ˜ì •] sendMessage í•¨ìˆ˜ (ë°”ë‚˜ë‚˜ ëª¨ë“œë„ íŒŒì¼ ì „ì†¡ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½) â–¼â–¼â–¼
            window.sendMessage = async function() {
                const inputBox = document.getElementById('input-box');
                const msg = inputBox.value.trim();

                // 1. ì „ì†¡ ì¤‘ì´ê±°ë‚˜, ë‚´ìš©(í…ìŠ¤íŠ¸/íŒŒì¼)ì´ ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ì¤‘ë‹¨
                if (isSending || (!msg && selectedFiles.length === 0)) return;
                
                isSending = true;
                if(!currentSessionId) await createNewSession();

                // UI ì´ˆê¸°í™”
                inputBox.value = ''; 
                inputBox.style.height = '48px'; 
                inputBox.style.overflowY = 'hidden';
                
                // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
                let displayMsg = msg;
                if (selectedFiles.length > 0) {
                    const fileBadges = selectedFiles.map(f => `\`ğŸ“ ${f.name}\``).join(' ');
                    displayMsg = `${fileBadges}\n\n${msg}`;
                }
                appendMessage('user', displayMsg, false);
                
                // ì „ì†¡í•  íŒŒì¼ ë°±ì—… í›„ ì´ˆê¸°í™”
                const filesToSend = [...selectedFiles];
                selectedFiles = []; 
                renderMiniPreview(); 

                // ë¡œë”©ë°” í‘œì‹œ
                const loading = document.createElement('div');
                loading.className = 'message model';
                // ë°”ë‚˜ë‚˜ ëª¨ë“œì¼ ë•ŒëŠ” ë¬¸êµ¬ ë³€ê²½
                const loadingText = (typeof isBananaMode !== 'undefined' && isBananaMode) ? "ğŸŒ Dreaming..." : "â³ Analyzing...";
                loading.innerHTML = `<div class="content">${loadingText}</div>`;
                chatContainer.appendChild(loading);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                try {
                    let res;
                    
                    // â˜… [í•µì‹¬ ë³€ê²½] ëª¨ë“  ëª¨ë“œì—ì„œ FormData ì‚¬ìš© (íŒŒì¼ ì „ì†¡ì„ ìœ„í•´)
                    const formData = new FormData();
                    formData.append('sessionId', currentSessionId);
                    formData.append('message', msg); // í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ (api/imageì—ì„œëŠ” 'prompt'ë¡œ ë°›ì„ ìˆ˜ ìˆê²Œ ì•„ë˜ì—ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ ì„œë²„ë¥¼ ë§ì¶¤)
                    
                    // ì„œë²„ì˜ /api/imageëŠ” req.body.promptë¥¼ ê¸°ëŒ€í•˜ë¯€ë¡œ, 
                    // ë°”ë‚˜ë‚˜ ëª¨ë“œì¼ ë•ŒëŠ” 'prompt'ë¼ëŠ” ì´ë¦„ìœ¼ë¡œë„ ê°’ì„ ë„£ì–´ì¤ë‹ˆë‹¤.
                    if (typeof isBananaMode !== 'undefined' && isBananaMode) {
                        formData.append('prompt', msg); 
                    }

                    formData.append('modelName', document.getElementById('model-select').value);
                    formData.append('modeName', document.getElementById('mode-select').value);
                    
                    // íŒŒì¼ ì¶”ê°€
                    filesToSend.forEach(file => {
                        formData.append('files', file);
                    });

                    // API ì—”ë“œí¬ì¸íŠ¸ ê²°ì •
                    const endpoint = (typeof isBananaMode !== 'undefined' && isBananaMode) ? '/api/image' : '/api/chat';

                    // ì „ì†¡ (Content-Type í—¤ë” ìƒëµ -> ë¸Œë¼ìš°ì € ìë™ ì„¤ì •)
                    res = await fetch(endpoint, { 
                        method: 'POST', 
                        body: formData 
                    });

                    const data = await res.json();
                    chatContainer.removeChild(loading);
                    
                    if (!res.ok) throw new Error(data.error || 'Server Error');
                    appendMessage('model', data.response, true);
                    
                    // â–¼â–¼â–¼ [ìˆ˜ì •] ì œëª©ì´ DBì— ì €ì¥ë  ì‹œê°„ì„ ë²Œì–´ì¤Œ (0.5ì´ˆ ë”œë ˆì´) â–¼â–¼â–¼
                    if (chatContainer.children.length <= 2) {
                        setTimeout(() => {
                            loadSessions(); 
                        }, 500); 
                    }
                    // â–²â–²â–² [ìˆ˜ì •] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²
                    
                } catch(e) {
                    if(loading.parentNode) chatContainer.removeChild(loading);
                    appendMessage('model', `âŒ Error: ${e.message}`, false);
                    console.error(e);
                } finally {
                    isSending = false;
                    document.getElementById('input-box').focus();
                }
            };
            // â–²â–²â–² [ìˆ˜ì • ì™„ë£Œ] â–²â–²â–²

            // â–²â–²â–² [ë³µë¶™] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²

            // â–¼â–¼â–¼ [ì¶”ê°€] íŒì—…ì°½ ë–  ìˆì„ ë•Œ ì—”í„°í‚¤ ëˆ„ë¥´ë©´ 'í™•ì¸' í´ë¦­ ì²˜ë¦¬ â–¼â–¼â–¼
            document.addEventListener('keydown', function(e) {
                const overlay = document.getElementById('custom-modal-overlay');
                // íŒì—…ì´ ë³´ì—¬ì§€ê³  ìˆê³ (flex), ëˆ„ë¥¸ í‚¤ê°€ Enterë¼ë©´?
                if (overlay && overlay.style.display === 'flex' && e.key === 'Enter') {
                    e.preventDefault(); // ì¤„ë°”ê¿ˆ ë“± ê¸°ë³¸ ë™ì‘ ë°©ì§€
                    const confirmBtn = document.getElementById('modal-confirm-btn');
                    if(confirmBtn) confirmBtn.click(); // í™•ì¸ ë²„íŠ¼ í´ë¦­ íŠ¸ë¦¬ê±°
                }
            });
            // â–²â–²â–² [ì¶”ê°€] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²

            // â–¼â–¼â–¼ [ê¸´ê¸‰ ìˆ˜ì •] ì „ì†¡ ë²„íŠ¼ì„ 'ë°”ë‚˜ë‚˜ ê¸°ëŠ¥'ê³¼ ë‹¤ì‹œ ì—°ê²°í•˜ê¸° â–¼â–¼â–¼
            (function fixSendButton() {
                const oldBtn = document.getElementById('send-btn');
                // 1. ê¸°ì¡´ ë²„íŠ¼ì„ ë³µì œí•´ì„œ 'ì˜›ë‚  ê¸°ì–µ(í…ìŠ¤íŠ¸ ì „ì†¡)'ì„ ì§€ì›Œë²„ë¦¼
                const newBtn = oldBtn.cloneNode(true);
                // 2. ìƒˆ ë²„íŠ¼ìœ¼ë¡œ êµì²´
                oldBtn.parentNode.replaceChild(newBtn, oldBtn);
                // 3. 'ìƒˆë¡œìš´ ê¸°ëŠ¥(ì´ë¯¸ì§€+í…ìŠ¤íŠ¸)' ì—°ê²°
                newBtn.addEventListener('click', window.sendMessage);
            })();
            // â–²â–²â–² [ê¸´ê¸‰ ìˆ˜ì •] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²

            // â–¼â–¼â–¼ [ì¶”ê°€] ì˜¤ë˜ëœ ì„¸ì…˜ ì •ë¦¬ ë¡œì§ â–¼â–¼â–¼
        let expiredIds = [];

        async function checkExpiredSessions() {
            try {
                // ì„œë²„ì— "1ë‹¬ ì§€ë‚œ ê±° ìˆì–´?" ë¬¼ì–´ë³´ê¸°
                const res = await fetch('/api/sessions/expired');
                const list = await res.json();
                
                if (list.length > 0) {
                    expiredIds = list.map(s => s.id);
                    
                    // ëª©ë¡ ê·¸ë¦¬ê¸°
                    const ul = document.getElementById('cleanup-list');
                    ul.innerHTML = '';
                    list.forEach(s => {
                        const d = new Date(s.created_at).toLocaleDateString();
                        const li = document.createElement('li');
                        li.style.cssText = "display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.05); color:var(--text-primary);";
                        li.innerHTML = `<span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width:70%;">${s.title}</span><span style="color:var(--text-dim);">${d}</span>`;
                        ul.appendChild(li);
                    });
                    
                    document.getElementById('cleanup-total-count').innerText = `${list.length}ê±´`;
                    
                    // íŒì—… ë„ìš°ê¸° (ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ ëœ¸)
                    document.getElementById('cleanup-modal-overlay').style.display = 'flex';
                }
            } catch (e) { console.error("Cleanup Check Failed", e); }
        }

        // ì·¨ì†Œ ë²„íŠ¼: ê·¸ëƒ¥ ë‹«ê¸°ë§Œ í•¨ (DB ì‚­ì œ ì•ˆ í•˜ë¯€ë¡œ ë‹¤ìŒ ë¡œê·¸ì¸ ë•Œ ë˜ ëœ¸)
        function closeCleanupModal() {
            document.getElementById('cleanup-modal-overlay').style.display = 'none';
        }

        // í™•ì¸ ë²„íŠ¼: ì‹¤ì œ ì‚­ì œ ìš”ì²­ ë³´ëƒ„
        async function performCleanup() {
            if (expiredIds.length === 0) return;
            
            const btn = document.querySelector('#cleanup-modal-overlay .btn-confirm');
            const originalText = btn.innerText;
            btn.innerText = "ì •ë¦¬ ì¤‘... â³";
            btn.disabled = true;

            try {
                const res = await fetch('/api/sessions/cleanup', { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ sessionIds: expiredIds }) 
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(`${data.count}ê°œì˜ ì˜¤ë˜ëœ ëŒ€í™”ê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, "âœ¨");
                    closeCleanupModal();
                    
                    // í˜„ì¬ ë³´ê³  ìˆë˜ ë°©ì´ ì§€ì›Œì¡Œì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ í™”ë©´ ê°±ì‹ 
                    if (expiredIds.includes(Number(currentSessionId))) {
                        await createNewSession();
                    } else {
                        await loadSessions();
                    }
                } else {
                    showToast("ì •ë¦¬ ì‹¤íŒ¨: " + data.error, "âŒ");
                }
            } catch (e) {
                showToast("ì˜¤ë¥˜ ë°œìƒ", "âŒ");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        // â–²â–²â–² [ì¶”ê°€] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²
    </script>